<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MEDNEXUS - Banco de Questões</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- jsPDF Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <!-- Configuração Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        slate: {
                            850: '#151e32',
                            900: '#0f172a',
                            950: '#020617',
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* Estilos Customizados */
        body {
            background-color: #0f172a;
            color: #cbd5e1;
            -webkit-font-smoothing: antialiased;
        }
        
        /* Scrollbar personalizada */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #0f172a;
        }
        ::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #475569;
        }

        /* Animações simples */
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        .slide-up {
            animation: slideUp 0.4s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .active-cycle {
            background-color: rgba(14, 165, 233, 0.1);
            border-color: #0ea5e9;
            box-shadow: 0 10px 15px -3px rgba(12, 74, 110, 0.2);
        }
        .active-cycle h3 { color: white; }
        .active-cycle .icon-box { background-color: #0ea5e9; color: white; }

        .chip-selected {
            background-color: #0284c7;
            color: white;
            border-color: #0ea5e9;
        }
        
        .option-eliminated {
            opacity: 0.5;
            text-decoration: line-through;
            background-color: rgba(15, 23, 42, 0.5);
        }

        /* Estilos de Feedback */
        .opt-correct {
            background-color: rgba(34, 197, 94, 0.15) !important;
            border-color: #22c55e !important;
        }
        .opt-correct .opt-letter {
            background-color: #22c55e;
            border-color: #22c55e;
            color: white;
        }
        
        .opt-wrong {
            background-color: rgba(239, 68, 68, 0.15) !important;
            border-color: #ef4444 !important;
        }
        .opt-wrong .opt-letter {
            background-color: #ef4444;
            border-color: #ef4444;
            color: white;
        }
        
        /* Botão Scroll Top */
        #btn-back-to-top {
            transition: all 0.3s ease-in-out;
            transform: translateY(0);
        }
        #btn-back-to-top.hidden-scroll {
            opacity: 0;
            pointer-events: none;
            transform: translateY(20px);
        }
    </style>
</head>
<body class="selection:bg-sky-500/30 relative">

    <!-- HEADER (Fixo) -->
    <header class="fixed top-0 w-full z-50 bg-slate-900/90 backdrop-blur-md border-b border-slate-800">
        <div class="max-w-[1400px] mx-auto px-4 md:px-6 h-16 flex items-center justify-between">
            <!-- Logo & Nav -->
            <div class="flex items-center gap-4">
                <div id="header-logo-area" class="flex items-center gap-2 cursor-pointer" onclick="resetToDashboard()">
                    <img src="https://raw.githubusercontent.com/acervo450-commits/mednexus/main/Banco%20de%20Quest%C3%B5es/BQ.png" 
                         alt="MEDNEXUS" 
                         class="h-10 w-auto object-contain hover:opacity-90 transition-opacity">
                </div>
                
                <div class="h-6 w-px bg-slate-800 mx-2 hidden sm:block"></div>
                
                <div id="nav-dashboard" class="flex items-center gap-2 text-sm">
                    <span class="text-sky-500 font-semibold bg-sky-500/10 px-3 py-1 rounded-full border border-sky-500/20">
                        Banco de Questões
                    </span>
                </div>

                <div id="nav-exam" class="hidden items-center gap-4 w-full">
                    <button onclick="exitExam()" class="flex items-center gap-2 text-slate-400 hover:text-white transition-colors">
                        <i data-lucide="arrow-left" class="w-5 h-5"></i>
                        <span class="font-medium">Sair</span>
                    </button>
                    
                    <div id="zen-progress-container" class="hidden flex-1 max-w-md mx-4 md:block">
                        <div class="flex justify-between text-xs text-slate-400 mb-1">
                            <span id="zen-current-q">Questão 1</span>
                            <span id="zen-total-q">de 10</span>
                        </div>
                        <div class="h-1.5 w-full bg-slate-800 rounded-full overflow-hidden">
                            <div id="zen-progress-bar" class="h-full bg-sky-500 transition-all duration-300" style="width: 0%"></div>
                        </div>
                    </div>

                    <button onclick="downloadPDF()" class="ml-auto flex items-center gap-2 px-3 py-1.5 bg-slate-800 hover:bg-slate-700 text-slate-300 rounded-lg border border-slate-700 transition-all text-sm">
                        <i data-lucide="download" class="w-4 h-4"></i>
                        <span class="hidden sm:inline">Baixar PDF</span>
                    </button>
                </div>
            </div>

            <!-- User Profile -->
            <div class="flex items-center gap-4">
                <div class="text-right hidden sm:block">
                    <p class="text-sm text-white font-medium">Dr. Rafael</p>
                    <p class="text-xs text-slate-500">Plano Extensivo 2024</p>
                </div>
                <div class="w-9 h-9 rounded-full bg-slate-700 border border-slate-600 flex items-center justify-center text-xs font-bold text-white">
                    DR
                </div>
            </div>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main class="pt-24 pb-12 px-4 md:px-6 max-w-[1400px] mx-auto min-h-screen">
        
        <!-- DASHBOARD VIEW -->
        <div id="dashboard-view" class="grid grid-cols-1 lg:grid-cols-3 gap-8 fade-in">
            <!-- Coluna Esquerda: Configurações -->
            <div class="lg:col-span-2 space-y-8 pb-20 lg:pb-0">
                <div class="mb-6 flex justify-between items-end flex-wrap gap-4">
                    <div>
                        <h1 class="text-3xl font-bold text-white mb-2">Configure seu Treino</h1>
                        <p class="text-slate-400">Base de dados atualizada: <span class="text-sky-400 font-mono font-bold" id="total-db-count">0</span> questões disponíveis.</p>
                    </div>
                    <div class="hidden md:flex items-center gap-2 px-3 py-1.5 bg-green-500/10 border border-green-500/20 rounded-full">
                        <i data-lucide="database" class="w-3.5 h-3.5 text-green-500"></i>
                        <span class="text-xs font-medium text-green-400">Banco Atualizado</span>
                    </div>
                </div>

                <section>
                    <div class="flex items-center gap-2 mb-4 text-sky-400">
                        <i data-lucide="layers" class="w-4.5 h-4.5"></i>
                        <h2 class="text-sm font-bold uppercase tracking-wider">1. Escolha o Ciclo</h2>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4" id="cycles-container"></div>
                </section>

                <section class="bg-slate-800/20 border border-slate-800 rounded-2xl p-6 relative overflow-hidden transition-all">
                    <div class="absolute top-0 right-0 w-64 h-64 bg-slate-800/20 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2 pointer-events-none"></div>
                    <div class="flex items-center justify-between mb-6 relative z-10 flex-wrap gap-4">
                        <div class="flex items-center gap-2 text-sky-400">
                            <i data-lucide="book-open" class="w-4.5 h-4.5"></i>
                            <h2 class="text-sm font-bold uppercase tracking-wider">2. Conteúdo</h2>
                        </div>
                        <div class="flex items-center gap-2 bg-slate-900/50 p-1 rounded-lg border border-slate-700/50">
                            <button onclick="setMode('traditional')" id="btn-mode-trad" class="px-3 py-1.5 text-xs font-medium rounded-md transition-all bg-slate-700 text-white shadow">Tradicional</button>
                            <button onclick="setMode('pbl')" id="btn-mode-pbl" class="px-3 py-1.5 text-xs font-medium rounded-md transition-all text-slate-500 hover:text-slate-300">PBL (Tutoria)</button>
                        </div>
                    </div>
                    <div id="content-area" class="relative z-10"></div>
                </section>
            </div>

            <!-- Coluna Direita: Resumo Sticky -->
            <div class="lg:col-span-1">
                <div class="sticky top-24 space-y-4">
                    <div class="bg-slate-850 border border-slate-800 rounded-2xl overflow-hidden shadow-xl">
                        <div class="p-4 border-b border-slate-800 bg-slate-900/50">
                            <div class="flex items-center gap-2 text-slate-300">
                                <i data-lucide="settings" class="w-4.5 h-4.5"></i>
                                <span class="font-semibold text-sm">Filtros da Prova</span>
                            </div>
                        </div>
                        <div class="p-5 space-y-4">
                            <div>
                                <h4 class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-3">Status</h4>
                                <div class="space-y-1" id="status-filters"></div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-gradient-to-br from-sky-900/20 to-slate-850 border border-sky-500/20 rounded-2xl p-6 shadow-2xl relative overflow-hidden">
                        <div class="absolute -top-10 -right-10 w-32 h-32 bg-sky-500/10 rounded-full blur-3xl"></div>
                        <div class="text-center mb-6 relative z-10">
                            <span class="text-slate-400 text-sm font-medium">Questões Encontradas</span>
                            <div id="q-counter" class="text-5xl font-bold text-white mt-1 tracking-tighter tabular-nums transition-all">0</div>
                            <p class="text-xs text-sky-400 mt-2 font-medium">Baseado na sua seleção</p>
                        </div>
                        <div class="mb-4 relative z-10">
                            <label class="block text-xs font-semibold text-slate-400 mb-2 uppercase tracking-wider text-center">Modo de Exibição</label>
                            <div class="grid grid-cols-2 gap-3">
                                <button onclick="setViewMode('list')" id="btn-view-list" class="p-3 rounded-lg border bg-sky-500/20 border-sky-500 text-white flex flex-col items-center gap-2 transition-all">
                                    <i data-lucide="layout-list" class="w-5 h-5"></i>
                                    <span class="text-[10px] font-bold uppercase">Lista</span>
                                </button>
                                <button onclick="setViewMode('zen')" id="btn-view-zen" class="p-3 rounded-lg border bg-slate-800 border-slate-700 text-slate-500 flex flex-col items-center gap-2 transition-all hover:bg-slate-700">
                                    <i data-lucide="maximize" class="w-5 h-5"></i>
                                    <span class="text-[10px] font-bold uppercase">Zen Mode</span>
                                </button>
                            </div>
                        </div>
                        <div class="mb-4 bg-slate-900/40 rounded-lg p-3 border border-sky-500/10 backdrop-blur-sm relative z-10">
                            <div class="flex items-center justify-center gap-3">
                                <button onclick="changeLimit(-5)" class="p-1.5 rounded-md bg-slate-800 border border-slate-700 hover:text-white text-slate-400"><i data-lucide="minus" class="w-4 h-4"></i></button>
                                <div class="relative">
                                    <input type="number" id="q-limit-input" value="10" class="w-16 bg-transparent text-center text-white font-bold outline-none text-lg appearance-none" onchange="manualLimitChange(this.value)">
                                    <span class="absolute right-0 top-2 text-[10px] text-slate-600 pointer-events-none">Qts</span>
                                </div>
                                <button onclick="changeLimit(5)" class="p-1.5 rounded-md bg-slate-800 border border-slate-700 hover:text-white text-slate-400"><i data-lucide="plus" class="w-4 h-4"></i></button>
                            </div>
                        </div>
                        <button onclick="startExam()" id="btn-generate" class="w-full py-4 rounded-xl font-bold text-base flex items-center justify-center gap-2 transition-all shadow-lg bg-slate-800 text-slate-500 cursor-not-allowed" disabled>
                            <i data-lucide="play" class="w-4 h-4 fill-current"></i>
                            GERAR CADERNO
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- EXAM VIEW (Hidden by default) -->
        <div id="exam-view" class="hidden fade-in max-w-4xl mx-auto">
            <div id="exam-header" class="text-center mb-8">
                <h2 class="text-2xl font-bold text-white">Caderno de Questões</h2>
                <p class="text-slate-400 text-sm">Modo: <span id="exam-mode-label" class="text-sky-400 font-bold">Lista</span></p>
            </div>
            <div id="questions-container" class="space-y-6"></div>
            <div id="zen-controls" class="hidden fixed bottom-0 left-0 w-full bg-slate-900/95 backdrop-blur border-t border-slate-800 p-4 z-40">
                <div class="max-w-4xl mx-auto flex items-center justify-between">
                    <button onclick="zenPrev()" id="btn-zen-prev" class="flex items-center gap-2 px-6 py-3 rounded-xl font-bold text-slate-300 hover:bg-slate-800 transition-colors disabled:opacity-50">
                        <i data-lucide="chevron-left"></i> Anterior
                    </button>
                    <span id="zen-counter" class="text-slate-500 font-mono text-sm">1 / 10</span>
                    <button onclick="zenNext()" id="btn-zen-next" class="flex items-center gap-2 px-6 py-3 rounded-xl font-bold bg-sky-600 hover:bg-sky-500 text-white shadow-lg transition-all disabled:opacity-50">
                        Próxima <i data-lucide="chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Botão Voltar ao Topo -->
        <button id="btn-back-to-top" onclick="scrollToTop()" class="hidden-scroll fixed bottom-6 right-6 p-3 bg-sky-600 text-white rounded-full shadow-lg hover:bg-sky-500 z-50 flex items-center justify-center border border-sky-400/20">
            <i data-lucide="arrow-up" class="w-6 h-6"></i>
        </button>

    </main>

    <!-- SCRIPTS LÓGICA DO APP -->
    <script>
        // --- 1. DADOS (Config) ---
        const CYCLES = [
            { id: 'basico', label: 'Ciclo Básico', icon: 'beaker', description: 'Módulos 1 ao 12 (Fundamentos)' },
            { id: 'clinico', label: 'Ciclo Clínico', icon: 'stethoscope', description: 'Módulos 13+ (Patologias)' },
            { id: 'internato', label: 'Internato', icon: 'graduation-cap', description: 'Prática e conduta médica' },
        ];

        // CONFIGURAÇÃO DAS DISCIPLINAS POR CICLO (ATUALIZADO)
        const DISCIPLINES = {
            basico: [
                'Anatomia', 'Fisiologia', 'Histologia', 'Bioquímica', 
                'Embriologia', 'Imunologia', 'Genética', 'Patologia Geral',
                'Ginecologia', 'Farmacologia', 'Saúde Coletiva' // Adicionados para suportar PBL Módulo 7
            ],
            clinico: [
                'Ginecologia', 
                'Obstetrícia', 
                'Cardiologia', 'Pneumologia', 'Gastroenterologia', 'Nefrologia', 
                'Neurologia', 'Infectologia', 'Reumatologia', 'Endocrinologia', 
                'Hematologia', 'Psiquiatria'
            ],
            internato: [
                'Ginecologia', 
                'Obstetrícia',
                'Clínica Médica', 'Cirurgia Geral', 'Pediatria', 
                'Medicina Preventiva', 'Medicina de Família', 'Urgência e Emergência'
            ]
        };

        // SUBTEMAS AGRUPADOS E PADRONIZADOS
        const SUB_TOPICS = {
            // --- GINECOLOGIA ---
            'Ginecologia': [
                'Fisiologia Hormonal e Ciclo Menstrual', // Inclui Feedback, Foliculogênese, Ovulação
                'Legislação e Planejamento Familiar', // Inclui Leis, Prazos
                'Anticoncepção e Farmacologia', // Inclui Critérios OMS, DIU, Injetáveis
                'Infecções em Ginecologia e Obstetrícia', // Inclui Sífilis, HIV, Tratamentos
                'Climatério e Menopausa',
                'Oncologia Ginecológica'
            ],

            // --- FISIOLOGIA (Básica) ---
            'Fisiologia': [
                'Fisiologia Hormonal e Ciclo Menstrual', // Compartilhado
                'Fisiologia Celular', 
                'Neurofisiologia', 
                'Cardiovascular', 
                'Respiratória', 
                'Renal', 
                'Endocrinologia'
            ],

            // --- SAÚDE COLETIVA ---
            'Saúde Coletiva': [
                'Legislação e Ética Médica',
                'Políticas de Saúde'
            ],

            // --- OBSTETRÍCIA ---
            'Obstetrícia': [
                'Modificações Fisiológicas da Gestação', 
                'Pré-Natal e Assistência à Gestante', 
                'Abortamento e Sangramentos da 1ª Metade', 
                'Estática Fetal e Anatomia Obstétrica', 
                'Mecanismo de Parto', 
                'Fases Clínicas do Trabalho de Parto', 
                'Parto: Vias e Assistência', 
                'Fisiologia e Clínica do Puerpério', 
                'Fisiologia da Lactação', 
                'Hemorragias Puerperais', 
                'Infecções Puerperais e Mamárias', 
                'Saúde Pública e Mental Materna'
            ],

            // --- OUTRAS ---
            'Anatomia': ['Sistema Esquelético', 'Sistema Muscular', 'Neuroanatomia', 'Sistema Circulatório', 'Sistema Respiratório', 'Sistema Digestório'],
            'Cardiologia': ['Hipertensão', 'Insuficiência Cardíaca', 'Arritmias', 'Valvopatias', 'DAC']
        };

        const PBL_MODULES = [
            'Mód. 1 - Concepção e Formação', 
            'Mód. 2 - Agressão e Defesa', 
            'Mód. 3 - Metabolismo', 
            'Mód. 4 - Cardiovascular',
            'Mód. 5 - Respiratório', 
            'Mód. 6 - Problemas Mentais', 
            'Mód. 7 - Percepção e Locomoção', // Nota: As questões vieram marcadas como M7
            'Mód. 8 - Envelhecimento'
        ];

        // --- BASE DE DADOS: MÓDULO 7 -> CICLO BÁSICO ---
        const REAL_QUESTIONS = [
            { id: '1', cycle: 'basico', discipline: 'Fisiologia', subTopic: 'Fisiologia Hormonal e Ciclo Menstrual', pblModule: 'Mód. 7 - Percepção e Locomoção', text: 'O controle central do ciclo menstrual reside no hipotálamo, especificamente no núcleo arqueado. Sobre a secreção do Hormônio Liberador de Gonadotrofina (GnRH), assinale a alternativa que descreve corretamente sua característica fundamental para a manutenção da função do eixo:', options: ['Sua secreção deve ser contínua e linear para manter os níveis estáveis de FSH e LH.', 'A liberação ocorre em pulsos rítmicos; uma secreção contínua levaria à desensibilização (down-regulation) dos receptores hipofisários.', 'O GnRH é secretado exclusivamente em resposta ao pico de progesterona na fase lútea.', 'A pulsatilidade do GnRH é controlada diretamente pelos níveis de inibina B, sem influência neural.'], correctIndex: 1, difficulty: 'media', status: 'unanswered', rationale: 'Gabarito: B. A secreção pulsátil do GnRH é essencial para evitar a desensibilização dos receptores hipofisários.' },
            { id: '2', cycle: 'basico', discipline: 'Fisiologia', subTopic: 'Fisiologia Hormonal e Ciclo Menstrual', pblModule: 'Mód. 7 - Percepção e Locomoção', text: 'A teoria das "Duas Células, Duas Gonadotrofinas" explica a produção de estrogênio no folículo ovariano. Qual é a função específica das Células da Teca neste processo?', options: ['Converter androgênios em estradiol através da enzima aromatase.', 'Produzir progesterona para sustentar o corpo lúteo inicial.', 'Captar colesterol e convertê-lo em androgênios sob estímulo do LH.', 'Captar colesterol e convertê-lo em androgênios sob estímulo do FSH.'], correctIndex: 2, difficulty: 'dificil', status: 'unanswered', rationale: 'Gabarito: C. As células da teca, sob estímulo do LH, produzem androgênios que serão convertidos em estrogênio na granulosa.' },
            { id: '3', cycle: 'basico', discipline: 'Fisiologia', subTopic: 'Fisiologia Hormonal e Ciclo Menstrual', pblModule: 'Mód. 7 - Percepção e Locomoção', text: 'As Células da Granulosa desempenham um papel crucial na foliculogênese. Por que elas dependem das Células da Teca para produzir estradiol?', options: ['Porque as Células da Granulosa não possuem receptores para FSH.', 'Porque elas não possuem a enzima aromatase necessária para a conversão final.', 'Porque elas não conseguem produzir os androgênios precursores, pois não possuem as enzimas necessárias para essa etapa inicial.', 'Porque o LH inibe a produção de estradiol diretamente na Granulosa.'], correctIndex: 2, difficulty: 'dificil', status: 'unanswered', rationale: 'Gabarito: C. As células da granulosa carecem das enzimas para a síntese de androgênios, dependendo da teca para fornecê-los.' },
            { id: '4', cycle: 'basico', discipline: 'Fisiologia', subTopic: 'Fisiologia Hormonal e Ciclo Menstrual', pblModule: 'Mód. 7 - Percepção e Locomoção', text: 'Qual enzima, induzida pelo FSH nas células da granulosa, é responsável pela conversão de androstenediona e testosterona em estradiol?', options: ['5-alfa-redutase.', 'Aromatase.', 'Colesterol desmolase.', '17-hidroxilase.'], correctIndex: 1, difficulty: 'facil', status: 'unanswered', rationale: 'Gabarito: B. A enzima aromatase converte androgênios em estrogênios.' },
            { id: '5', cycle: 'basico', discipline: 'Fisiologia', subTopic: 'Fisiologia Hormonal e Ciclo Menstrual', pblModule: 'Mód. 7 - Percepção e Locomoção', text: 'Para que ocorra o Pico de LH e a consequente ovulação, é necessário um evento específico de feedback positivo. Quais são as condições críticas de nível de estradiol e duração necessárias para disparar este evento?', options: ['Estradiol > 100 pg/mL por 24 horas.', 'Estradiol > 200 pg/mL por cerca de 50 horas.', 'Estradiol > 400 pg/mL por 12 horas.', 'Queda abrupta do estradiol seguida de aumento de progesterona.'], correctIndex: 1, difficulty: 'media', status: 'unanswered', rationale: 'Gabarito: B. Níveis sustentados de estradiol acima de 200 pg/mL por cerca de 50h desencadeiam o feedback positivo do LH.' },
            { id: '6', cycle: 'basico', discipline: 'Fisiologia', subTopic: 'Fisiologia Hormonal e Ciclo Menstrual', pblModule: 'Mód. 7 - Percepção e Locomoção', text: 'O pico de LH desencadeia uma série de eventos que culminam na ovulação. Dentre os eventos citados abaixo, qual NÃO é desencadeado diretamente por este pico?', options: ['Retomada da meiose do oócito (de prófase I para metáfase II).', 'Produção de enzimas proteolíticas como a colagenase.', 'Início da secreção de FSH para recrutamento da próxima coorte folicular.', 'Ruptura folicular e liberação do ovócito.'], correctIndex: 2, difficulty: 'media', status: 'unanswered', rationale: 'Gabarito: C. O pico de LH promove a maturação e ruptura folicular, mas o recrutamento da próxima coorte é dependente de FSH na fase seguinte.' },
            { id: '7', cycle: 'basico', discipline: 'Fisiologia', subTopic: 'Fisiologia Hormonal e Ciclo Menstrual', pblModule: 'Mód. 7 - Percepção e Locomoção', text: 'Cronologicamente, quanto tempo após o início do pico de LH ocorre a ovulação?', options: ['2 a 4 horas.', '10 a 12 horas.', '16 a 32 horas.', '48 a 72 horas.'], correctIndex: 2, difficulty: 'facil', status: 'unanswered', rationale: 'Gabarito: C. A ovulação ocorre tipicamente 32 a 36 horas após o início do pico de LH (ou 10-12h após o pico máximo).' },
            { id: '8', cycle: 'basico', discipline: 'Fisiologia', subTopic: 'Fisiologia Hormonal e Ciclo Menstrual', pblModule: 'Mód. 7 - Percepção e Locomoção', text: 'Se não houver fecundação, o corpo lúteo degenera. Qual é o mecanismo fisiológico imediato que leva à menstruação (descamação endometrial)?', options: ['Aumento súbito de FSH causando necrose tecidual.', 'Queda abrupta da progesterona causando constrição das artérias espiraladas e isquemia.', 'Excesso de produção de hCG pelo endométrio não receptivo.', 'Inibição direta do endométrio pela prolactina.'], correctIndex: 1, difficulty: 'media', status: 'unanswered', rationale: 'Gabarito: B. A queda da progesterona leva à vasoconstrição das artérias espiraladas e isquemia do endométrio funcional.' },
            { id: '9', cycle: 'basico', discipline: 'Ginecologia', subTopic: 'Legislação e Planejamento Familiar', pblModule: 'Mód. 7 - Percepção e Locomoção', text: 'A Lei 14.443/2022 trouxe mudanças significativas para o planejamento familiar no Brasil. Em relação ao consentimento para esterilização cirúrgica (laqueadura ou vasectomia), o que mudou?', options: ['O consentimento do cônjuge continua obrigatório apenas para mulheres.', 'O consentimento do cônjuge continua obrigatório apenas para homens.', 'A autorização do cônjuge foi dispensada, tornando a decisão um ato personalíssimo.', 'É necessária a autorização de uma junta médica em caso de discordância conjugal.'], correctIndex: 2, difficulty: 'facil', status: 'unanswered', rationale: 'Gabarito: C. A nova lei dispensa o consentimento do cônjuge para a esterilização voluntária.' },
            { id: '10', cycle: 'basico', discipline: 'Ginecologia', subTopic: 'Legislação e Planejamento Familiar', pblModule: 'Mód. 7 - Percepção e Locomoção', text: 'Qual é a nova idade mínima para realização de esterilização cirúrgica voluntária no Brasil, segundo a Lei 14.443/2022?', options: ['18 anos.', '21 anos.', '25 anos.', '30 anos.'], correctIndex: 1, difficulty: 'facil', status: 'unanswered', rationale: 'Gabarito: B. A idade mínima foi reduzida para 21 anos.' },
            { id: '11', cycle: 'basico', discipline: 'Ginecologia', subTopic: 'Legislação e Planejamento Familiar', pblModule: 'Mód. 7 - Percepção e Locomoção', text: 'Existe uma exceção à regra da idade mínima para esterilização cirúrgica. Em qual situação uma pessoa com menos de 21 anos pode realizar o procedimento?', options: ['Se tiver autorização judicial.', 'Se tiver o consentimento dos pais.', 'Se tiver pelo menos dois filhos vivos.', 'Se for casada civilmente há mais de 2 anos.'], correctIndex: 2, difficulty: 'facil', status: 'unanswered', rationale: 'Gabarito: C. Ter pelo menos dois filhos vivos permite a esterilização antes dos 21 anos.' },
            { id: '12', cycle: 'basico', discipline: 'Ginecologia', subTopic: 'Legislação e Planejamento Familiar', pblModule: 'Mód. 7 - Percepção e Locomoção', text: 'Sobre a realização de laqueadura durante o período de parto, o que determina a legislação atual (Lei 14.443/2022)?', options: ['É estritamente proibida, devido ao risco de arrependimento puerperal.', 'É permitida apenas se a paciente tiver tido cesáreas anteriores sucessivas.', 'É permitida, desde que a vontade tenha sido manifestada com no mínimo 60 dias de antecedência.', 'É permitida sem restrições de prazo, bastando o consentimento verbal na hora do parto.'], correctIndex: 2, difficulty: 'media', status: 'unanswered', rationale: 'Gabarito: C. É permitida no parto, desde que respeitado o prazo de 60 dias entre a manifestação da vontade e o ato cirúrgico.' },
            { id: '13', cycle: 'basico', discipline: 'Ginecologia', subTopic: 'Anticoncepção e Farmacologia', pblModule: 'Mód. 7 - Percepção e Locomoção', text: 'Segundo os Critérios Médicos de Elegibilidade da OMS, como é definida a Categoria 4?', options: ['Uma condição em que as vantagens do método superam os riscos teóricos ou comprovados.', 'Uma condição onde os riscos teóricos ou comprovados superam as vantagens.', 'Uma condição que representa um risco inaceitável à saúde se o método for utilizado (contraindicação absoluta).', 'Uma condição para a qual não há restrições ao uso do método.'], correctIndex: 2, difficulty: 'facil', status: 'unanswered', rationale: 'Gabarito: C. Categoria 4 indica risco inaceitável (contraindicação absoluta).' },
            { id: '14', cycle: 'basico', discipline: 'Ginecologia', subTopic: 'Anticoncepção e Farmacologia', pblModule: 'Mód. 7 - Percepção e Locomoção', text: 'Qual das situações abaixo representa um exemplo clássico de Categoria 4 da OMS para o uso de contraceptivos contendo estrogênio?', options: ['Tabagismo em mulheres com menos de 35 anos.', 'História familiar de câncer de mama.', 'Enxaqueca com aura (focal).', 'Obesidade (IMC > 30).'], correctIndex: 2, difficulty: 'media', status: 'unanswered', rationale: 'Gabarito: C. Enxaqueca com aura é Categoria 4 para estrogênios devido ao risco elevado de AVC.' },
            { id: '15', cycle: 'basico', discipline: 'Ginecologia', subTopic: 'Anticoncepção e Farmacologia', pblModule: 'Mód. 7 - Percepção e Locomoção', text: 'O uso de pílulas combinadas em lactantes entre 6 semanas e 6 meses pós-parto é classificado como Categoria 3. O que isso significa na prática clínica?', options: ['O método é a primeira escolha.', 'O método não deve ser usado, pois os riscos superam os benefícios, a menos que não haja outra opção disponível.', 'O uso é irrestrito e seguro.', 'É uma contraindicação absoluta e fatal.'], correctIndex: 1, difficulty: 'media', status: 'unanswered', rationale: 'Gabarito: B. Categoria 3 indica que os riscos superam os benefícios.' },
            { id: '16', cycle: 'basico', discipline: 'Ginecologia', subTopic: 'Anticoncepção e Farmacologia', pblModule: 'Mód. 7 - Percepção e Locomoção', text: 'Qual é o principal mecanismo de ação do Dispositivo Intrauterino (DIU) de Cobre?', options: ['Inibição da ovulação através da liberação sistêmica de íons.', 'Atrofia severa do endométrio impedindo a nidação.', 'Criação de um ambiente intrauterino hostil via íons de cobre, que possuem ação espermicida e impedem a fertilização.', 'Espessamento do muco cervical sem afetar a motilidade dos espermatozoides.'], correctIndex: 2, difficulty: 'facil', status: 'unanswered', rationale: 'Gabarito: C. O cobre cria um ambiente inflamatório estéril e espermicida.' },
            { id: '17', cycle: 'basico', discipline: 'Ginecologia', subTopic: 'Anticoncepção e Farmacologia', pblModule: 'Mód. 7 - Percepção e Locomoção', text: 'Sobre o SIU de Levonorgestrel (Mirena), é correto afirmar que:', options: ['Ele inibe a ovulação em 100% das usuárias.', 'A amenorreia observada é causada pela inibição total do eixo hipotálamo-hipófise.', 'Atua localmente atrofiando o endométrio e espessando o muco cervical; a anovulação ocorre em apenas 20-30% das usuárias.', 'Seu mecanismo principal é espermicida, similar ao cobre.'], correctIndex: 2, difficulty: 'media', status: 'unanswered', rationale: 'Gabarito: C. O efeito é principalmente local; a maioria das usuárias continua ovulando.' },
            { id: '18', cycle: 'basico', discipline: 'Ginecologia', subTopic: 'Anticoncepção e Farmacologia', pblModule: 'Mód. 7 - Percepção e Locomoção', text: 'O Acetato de Medroxiprogesterona de Depósito (injetável trimestral) está associado a alguns efeitos adversos específicos devido à sua alta potência na inibição do eixo. Qual das opções abaixo cita corretamente esses efeitos?', options: ['Aumento excessivo da densidade mineral óssea e retorno imediato da fertilidade.', 'Redução reversível da densidade mineral óssea e retorno tardio da fertilidade (9 a 12 meses).', 'Aumento do risco de câncer de ovário e retorno da fertilidade em 1 mês.', 'Hiperplasia endometrial e sangramento excessivo.'], correctIndex: 1, difficulty: 'dificil', status: 'unanswered', rationale: 'Gabarito: B. Pode causar perda óssea reversível e atraso no retorno da fertilidade.' },
            { id: '19', cycle: 'basico', discipline: 'Ginecologia', subTopic: 'Infecções em Ginecologia e Obstetrícia', pblModule: 'Mód. 7 - Percepção e Locomoção', text: 'No diagnóstico da sífilis, os testes treponêmicos e não-treponêmicos têm funções distintas. Qual é a principal característica dos testes treponêmicos (ex: Teste Rápido, FTA-Abs)?', options: ['São utilizados quantitativamente para controle de cura.', 'Negativam alguns meses após o tratamento eficaz.', 'Permanecem positivos por toda a vida (cicatriz sorológica) na maioria dos casos.', 'Estão sujeitos ao efeito prozona em altas titulações.'], correctIndex: 2, difficulty: 'media', status: 'unanswered', rationale: 'Gabarito: C. Testes treponêmicos tendem a permanecer positivos (cicatriz sorológica).' },
            { id: '20', cycle: 'basico', discipline: 'Ginecologia', subTopic: 'Infecções em Ginecologia e Obstetrícia', pblModule: 'Mód. 7 - Percepção e Locomoção', text: 'O que é o "Efeito Prozona" que pode ocorrer no diagnóstico da sífilis secundária?', options: ['Um falso-positivo causado por reação cruzada com outras doenças.', 'Um falso-negativo no teste não-treponêmico (VDRL) devido ao excesso de anticorpos na amostra não diluída.', 'A reativação da sífilis após tratamento inadequado.', 'A positividade persistente mesmo após a cura bacteriológica.'], correctIndex: 1, difficulty: 'dificil', status: 'unanswered', rationale: 'Gabarito: B. Excesso de anticorpos impede a aglutinação visível (falso-negativo).' },
            { id: '21', cycle: 'basico', discipline: 'Ginecologia', subTopic: 'Infecções em Ginecologia e Obstetrícia', pblModule: 'Mód. 7 - Percepção e Locomoção', text: 'Para o controle de cura da sífilis, qual tipo de teste é o indicado?', options: ['Teste Rápido.', 'FTA-Abs.', 'ELISA.', 'VDRL (Teste não-treponêmico).'], correctIndex: 3, difficulty: 'facil', status: 'unanswered', rationale: 'Gabarito: D. VDRL é quantitativo e seus títulos caem com a cura.' },
            { id: '22', cycle: 'basico', discipline: 'Ginecologia', subTopic: 'Infecções em Ginecologia e Obstetrícia', pblModule: 'Mód. 7 - Percepção e Locomoção', text: 'Qual é o esquema de tratamento recomendado pelo Ministério da Saúde para um paciente diagnosticado com Sífilis Latente Tardia (mais de 1 ano de evolução) ou de duração ignorada?', options: ['Penicilina Benzatina 2,4 milhões UI, dose única.', 'Penicilina Benzatina 2,4 milhões UI, semanal, por 3 semanas (Total: 7,2 milhões UI).', 'Ceftriaxona 1g dose única.', 'Doxiciclina 100mg por 7 dias.'], correctIndex: 1, difficulty: 'media', status: 'unanswered', rationale: 'Gabarito: B. Sífilis tardia requer 3 doses semanais de 2,4 milhões UI.' },
            { id: '23', cycle: 'basico', discipline: 'Ginecologia', subTopic: 'Infecções em Ginecologia e Obstetrícia', pblModule: 'Mód. 7 - Percepção e Locomoção', text: 'Para o tratamento da Sífilis Recente (Primária, Secundária ou Latente < 1 ano), a dose recomendada de Penicilina Benzatina é:', options: ['1,2 milhão UI, dose única.', '2,4 milhões UI, dose única.', '4,8 milhões UI, divididas em duas doses.', '7,2 milhões UI, divididas em três semanas.'], correctIndex: 1, difficulty: 'facil', status: 'unanswered', rationale: 'Gabarito: B. Sífilis recente é tratada com dose única de 2,4 milhões UI.' },
            { id: '24', cycle: 'basico', discipline: 'Ginecologia', subTopic: 'Infecções em Ginecologia e Obstetrícia', pblModule: 'Mód. 7 - Percepção e Locomoção', text: 'No manejo sindrômico ou etiológico de uretrites/cervicites causadas por Gonorreia e Clamídia, qual é o tratamento preferencial atual?', options: ['Ciprofloxacino 500mg VO dose única.', 'Penicilina Benzatina 2,4 milhões UI.', 'Ceftriaxona 500mg IM + Azitromicina 1g VO.', 'Metronidazol 2g VO dose única.'], correctIndex: 2, difficulty: 'media', status: 'unanswered', rationale: 'Gabarito: C. Cobre Neisseria gonorrhoeae (Ceftriaxona) e Chlamydia trachomatis (Azitromicina).' },
            { id: '25', cycle: 'basico', discipline: 'Ginecologia', subTopic: 'Infecções em Ginecologia e Obstetrícia', pblModule: 'Mód. 7 - Percepção e Locomoção', text: 'Sobre a infecção aguda pelo HIV e o diagnóstico, o termo "janela imunológica" refere-se a:', options: ['Período em que o vírus está latente e não é transmissível.', 'Intervalo entre a infecção e a detecção de anticorpos ou antígenos pelos testes diagnósticos.', 'Período em que o paciente apresenta sintomas de gripe forte.', 'Tempo necessário para o vírus destruir todo o sistema imune.'], correctIndex: 1, difficulty: 'facil', status: 'unanswered', rationale: 'Gabarito: B. É o tempo até o teste virar positivo após a exposição.' },
            { id: '26', cycle: 'basico', discipline: 'Ginecologia', subTopic: 'Infecções em Ginecologia e Obstetrícia', pblModule: 'Mód. 7 - Percepção e Locomoção', text: 'Os testes de HIV de 4ª geração representaram um avanço significativo no diagnóstico precoce. O que eles detectam que permite reduzir a janela imunológica para cerca de 15-20 dias?', options: ['Apenas anticorpos IgG e IgM.', 'O RNA viral diretamente.', 'O antígeno p24 simultaneamente aos anticorpos.', 'A transcriptase reversa viral.'], correctIndex: 2, difficulty: 'media', status: 'unanswered', rationale: 'Gabarito: C. Detectam anticorpos e o antígeno p24 (viral).' },
            { id: '27', cycle: 'basico', discipline: 'Ginecologia', subTopic: 'Infecções em Ginecologia e Obstetrícia', pblModule: 'Mód. 7 - Percepção e Locomoção', text: 'De acordo com os fluxogramas de diagnóstico do HIV no Brasil, se um teste de triagem (ex: teste rápido ou imunoensaio) for reagente, qual é a conduta imediata?', options: ['Iniciar o tratamento antirretroviral imediatamente, sem novos exames.', 'Repetir o mesmo teste em 30 dias.', 'Realizar um teste confirmatório mais específico (como Western Blot, Imunoblot ou teste molecular) para descartar falso-positivos.', 'Considerar o paciente negativo se ele for assintomático.'], correctIndex: 2, difficulty: 'media', status: 'unanswered', rationale: 'Gabarito: C. Um teste reagente exige confirmação com outro método.' },
            { id: '28', cycle: 'basico', discipline: 'Ginecologia', subTopic: 'Infecções em Ginecologia e Obstetrícia', pblModule: 'Mód. 7 - Percepção e Locomoção', text: 'O tratamento das parcerias sexuais é obrigatório em casos de ISTs como clamídia e gonorreia. Qual é o principal objetivo dessa medida?', options: ['Apenas reduzir a ansiedade do parceiro.', 'Quebrar a cadeia de transmissão e evitar a reinfecção do paciente tratado (efeito "ping-pong").', 'Cumprir uma exigência burocrática da notificação compulsória.', 'Garantir a esterilidade do casal.'], correctIndex: 1, difficulty: 'facil', status: 'unanswered', rationale: 'Gabarito: B. Evitar a reinfecção (efeito pingue-pongue) e transmissão.' },
            { id: '29', cycle: 'basico', discipline: 'Fisiologia', subTopic: 'Fisiologia Hormonal e Ciclo Menstrual', pblModule: 'Mód. 7 - Percepção e Locomoção', text: 'Na farmacologia, o uso de análogos de GnRH de forma contínua é utilizado para tratar endometriose e puberdade precoce. Qual mecanismo fisiológico explica a eficácia desse tratamento?', options: ['Estímulo da pulsatilidade natural.', 'Aumento da sensibilidade dos receptores hipofisários.', 'Desensibilização (down-regulation) dos receptores e bloqueio da liberação de gonadotrofinas.', 'Conversão periférica de GnRH em estrogênio.'], correctIndex: 2, difficulty: 'dificil', status: 'unanswered', rationale: 'Gabarito: C. A exposição contínua ao GnRH dessensibiliza a hipófise, inibindo FSH/LH.' },
            { id: '30', cycle: 'basico', discipline: 'Ginecologia', subTopic: 'Legislação e Planejamento Familiar', pblModule: 'Mód. 7 - Percepção e Locomoção', text: 'A exigência de autorização do cônjuge para procedimentos de esterilização na lei antiga (9.263/1996) era frequentemente criticada. Qual termo era utilizado pelos críticos para descrever essa submissão da autonomia corporal da mulher?', options: ['Proteção familiar.', 'Tutela conjugal ou servidão patriarcal.', 'Responsabilidade compartilhada.', 'Consentimento informado mútuo.'], correctIndex: 1, difficulty: 'facil', status: 'unanswered', rationale: 'Gabarito: B. Era vista como uma tutela indevida sobre o corpo da mulher.' },
            { id: '31', cycle: 'basico', discipline: 'Ginecologia', subTopic: 'Anticoncepção e Farmacologia', pblModule: 'Mód. 7 - Percepção e Locomoção', text: 'Por que o estrogênio é contraindicado (Categoria 4) em pacientes com enxaqueca com aura?', options: ['Porque aumenta a frequência das crises de dor.', 'Porque anula o efeito dos analgésicos.', 'Devido ao risco sinérgico elevado de Acidente Vascular Cerebral (AVC) isquêmico.', 'Porque causa hipotensão severa nessas pacientes.'], correctIndex: 2, difficulty: 'media', status: 'unanswered', rationale: 'Gabarito: C. A combinação aumenta drasticamente o risco de AVC isquêmico.' },
            { id: '32', cycle: 'basico', discipline: 'Ginecologia', subTopic: 'Legislação e Planejamento Familiar', pblModule: 'Mód. 7 - Percepção e Locomoção', text: 'A Lei 14.443/2022 mantém um prazo mínimo de reflexão entre a manifestação da vontade de esterilização e a cirurgia. Qual é a duração desse prazo e seu objetivo?', options: ['30 dias, para agendamento hospitalar.', '60 dias, visando garantir o consentimento informado e reduzir riscos de arrependimento.', '90 dias, para avaliação psicológica obrigatória.', '180 dias, para tentativa de outros métodos reversíveis.'], correctIndex: 1, difficulty: 'facil', status: 'unanswered', rationale: 'Gabarito: B. O prazo legal é de 60 dias para reflexão.' },
            { id: '33', cycle: 'basico', discipline: 'Fisiologia', subTopic: 'Fisiologia Hormonal e Ciclo Menstrual', pblModule: 'Mód. 7 - Percepção e Locomoção', text: 'Qual hormônio é responsável por estimular as células da granulosa a produzirem a enzima aromatase?', options: ['LH.', 'FSH.', 'GnRH.', 'Progesterona.'], correctIndex: 1, difficulty: 'media', status: 'unanswered', rationale: 'Gabarito: B. O FSH estimula a atividade da aromatase na granulosa.' },
            { id: '34', cycle: 'basico', discipline: 'Ginecologia', subTopic: 'Infecções em Ginecologia e Obstetrícia', pblModule: 'Mód. 7 - Percepção e Locomoção', text: 'Qual é a única droga considerada segura e eficaz para prevenir a transmissão vertical da sífilis (sífilis congênita) durante a gestação?', options: ['Doxiciclina.', 'Eritromicina.', 'Ceftriaxona.', 'Penicilina Benzatina.'], correctIndex: 3, difficulty: 'media', status: 'unanswered', rationale: 'Gabarito: D. Apenas a Penicilina trata a mãe e o feto adequadamente.' }
        ];

        // --- 2. STATE ---
        const state = {
            cycle: 'basico', // Padrão alterado para refletir o módulo 7 (Básico)
            disciplines: [],
            subTopics: [],
            usePBL: false,
            pblModules: [],
            filters: { unanswered: true, wrong: false },
            limit: 10,
            viewMode: 'list',
            filteredQuestions: [],
            examQuestions: [],
            currentZenIndex: 0,
            eliminatedOptions: {}, 
            userAnswers: {}, 
            db: []
        };

        // --- 3. INICIALIZAÇÃO ---
        function init() {
            generateMockDB();
            renderCycles();
            renderContentArea();
            renderStatusFilters();
            updateCounter();
            lucide.createIcons();
        }

        function generateMockDB() {
            let mocks = [];
            state.db = [...REAL_QUESTIONS, ...mocks];
            document.getElementById('total-db-count').innerText = state.db.length;
        }

        // --- 4. RENDERIZAÇÃO DASHBOARD ---
        function renderCycles() {
            const container = document.getElementById('cycles-container');
            container.innerHTML = CYCLES.map(c => `
                <button onclick="selectCycle('${c.id}')" class="relative p-5 rounded-xl border text-left transition-all duration-300 group ${state.cycle === c.id ? 'active-cycle' : 'bg-slate-800/40 border-slate-700 hover:border-slate-500 hover:bg-slate-800/80'}">
                    <div class="flex items-start justify-between mb-2">
                        <div class="icon-box p-2 rounded-lg transition-colors ${state.cycle === c.id ? '' : 'bg-slate-700 text-slate-400 group-hover:text-slate-200'}">
                            <i data-lucide="${c.icon}" class="w-5 h-5"></i>
                        </div>
                        ${state.cycle === c.id ? '<div class="w-5 h-5 bg-sky-500 rounded-full flex items-center justify-center"><i data-lucide="check" class="w-3 h-3 text-white"></i></div>' : ''}
                    </div>
                    <h3 class="font-semibold mb-1 ${state.cycle === c.id ? 'text-white' : 'text-slate-300 group-hover:text-white'}">${c.label}</h3>
                    <p class="text-xs text-slate-500">${c.description}</p>
                </button>
            `).join('');
            lucide.createIcons();
        }

        function renderContentArea() {
            const container = document.getElementById('content-area');
            if (state.usePBL) {
                container.innerHTML = `
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 fade-in">
                        ${PBL_MODULES.map(mod => `
                            <button onclick="togglePBL('${mod}')" class="p-3 rounded-lg border text-sm text-left transition-all flex items-center gap-3 ${state.pblModules.includes(mod) ? 'bg-purple-600/20 border-purple-500 text-white' : 'bg-slate-900 border-slate-700 text-slate-400 hover:border-slate-600'}">
                                <div class="w-4 h-4 rounded border flex items-center justify-center ${state.pblModules.includes(mod) ? 'bg-purple-500 border-purple-500' : 'border-slate-600'}">
                                    ${state.pblModules.includes(mod) ? '<i data-lucide="check" class="w-3 h-3 text-white"></i>' : ''}
                                </div>
                                ${mod}
                            </button>
                        `).join('')}
                    </div>
                `;
            } else {
                const disciplines = DISCIPLINES[state.cycle];
                const allSelected = state.disciplines.length === disciplines.length;
                let html = `
                    <div class="flex justify-between items-center mb-4 fade-in">
                        <p class="text-sm text-slate-400">Disciplinas: </p>
                        <button onclick="toggleAllDisciplines()" class="text-xs font-medium text-sky-400 hover:underline">
                            ${allSelected ? 'Desmarcar todas' : 'Selecionar todas'}
                        </button>
                    </div>
                    <div class="flex flex-wrap gap-2 mb-6">
                        ${disciplines.map(disc => `
                            <button onclick="toggleDiscipline('${disc}')" class="px-3 py-1.5 rounded-lg text-xs font-medium border transition-all ${state.disciplines.includes(disc) ? 'chip-selected shadow-md' : 'bg-slate-800/50 text-slate-400 border-slate-700 hover:border-slate-600 hover:text-slate-200'}">
                                ${disc}
                            </button>
                        `).join('')}
                    </div>
                `;
                
                // Renderização Dinâmica dos Subtópicos
                const relevantSubTopics = state.disciplines.filter(d => SUB_TOPICS[d]);
                if (relevantSubTopics.length > 0) {
                    html += `
                        <div class="mt-6 pt-6 border-t border-slate-700/50 slide-up">
                            <h3 class="text-sm font-bold text-slate-400 mb-4 flex items-center gap-2">
                                <i data-lucide="list-filter" class="w-4 h-4 text-sky-500"></i> Filtrar por Temas
                            </h3>
                            <div class="space-y-4">
                                ${relevantSubTopics.map(disc => `
                                    <div class="bg-slate-900/30 rounded-lg p-3 border border-slate-700/30">
                                        <span class="text-xs font-bold text-sky-400 uppercase tracking-wide mb-2 block">${disc}</span>
                                        <div class="flex flex-wrap gap-2">
                                            ${SUB_TOPICS[disc].map(sub => `
                                                <button onclick="toggleSubTopic('${sub}')" class="px-3 py-1.5 rounded-lg text-[10px] font-medium border transition-all ${state.subTopics.includes(sub) ? 'bg-sky-600 text-white border-sky-500' : 'bg-slate-900/80 text-slate-400 border-slate-700 hover:text-slate-200'}">
                                                    ${sub}
                                                </button>
                                            `).join('')}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
                container.innerHTML = html;
            }
            lucide.createIcons();
        }

        function renderStatusFilters() {
            const container = document.getElementById('status-filters');
            container.innerHTML = `
                <div class="flex items-center justify-between py-2">
                    <span class="text-sm text-slate-300 font-medium">Não Respondidas</span>
                    <button onclick="toggleFilter('unanswered')" class="w-11 h-6 rounded-full transition-colors relative ${state.filters.unanswered ? 'bg-sky-500' : 'bg-slate-700'}">
                        <div class="absolute top-1 left-1 bg-white w-4 h-4 rounded-full transition-transform ${state.filters.unanswered ? 'translate-x-5' : 'translate-x-0'}"></div>
                    </button>
                </div>
                <div class="flex items-center justify-between py-2">
                    <span class="text-sm text-slate-300 font-medium">Erros (Revisão)</span>
                    <button onclick="toggleFilter('wrong')" class="w-11 h-6 rounded-full transition-colors relative ${state.filters.wrong ? 'bg-sky-500' : 'bg-slate-700'}">
                        <div class="absolute top-1 left-1 bg-white w-4 h-4 rounded-full transition-transform ${state.filters.wrong ? 'translate-x-5' : 'translate-x-0'}"></div>
                    </button>
                </div>
            `;
        }

        // --- LÓGICA DE INTERAÇÃO ---
        function selectCycle(id) {
            state.cycle = id; state.disciplines = []; state.subTopics = []; state.pblModules = []; state.usePBL = false;
            renderCycles(); renderContentArea(); updateCounter();
        }
        function setMode(mode) {
            state.usePBL = (mode === 'pbl');
            document.getElementById('btn-mode-trad').className = !state.usePBL ? 'px-3 py-1.5 text-xs font-medium rounded-md transition-all bg-slate-700 text-white shadow' : 'px-3 py-1.5 text-xs font-medium rounded-md transition-all text-slate-500 hover:text-slate-300';
            document.getElementById('btn-mode-pbl').className = state.usePBL ? 'px-3 py-1.5 text-xs font-medium rounded-md transition-all bg-purple-600 text-white shadow' : 'px-3 py-1.5 text-xs font-medium rounded-md transition-all text-slate-500 hover:text-slate-300';
            renderContentArea(); updateCounter();
        }
        function toggleDiscipline(disc) {
            if (state.disciplines.includes(disc)) state.disciplines = state.disciplines.filter(d => d !== disc); else state.disciplines.push(disc);
            renderContentArea(); updateCounter();
        }
        function toggleAllDisciplines() {
            const all = DISCIPLINES[state.cycle];
            if (state.disciplines.length === all.length) { state.disciplines = []; state.subTopics = []; } else state.disciplines = [...all];
            renderContentArea(); updateCounter();
        }
        function toggleSubTopic(sub) {
            if (state.subTopics.includes(sub)) state.subTopics = state.subTopics.filter(s => s !== sub); else state.subTopics.push(sub);
            renderContentArea(); updateCounter();
        }
        function togglePBL(mod) {
            if (state.pblModules.includes(mod)) state.pblModules = state.pblModules.filter(m => m !== mod); else state.pblModules.push(mod);
            renderContentArea(); updateCounter();
        }
        function toggleFilter(key) { state.filters[key] = !state.filters[key]; renderStatusFilters(); updateCounter(); }
        function setViewMode(mode) {
            state.viewMode = mode;
            const btnList = document.getElementById('btn-view-list');
            const btnZen = document.getElementById('btn-view-zen');
            if(mode === 'list') {
                btnList.className = "p-3 rounded-lg border bg-sky-500/20 border-sky-500 text-white flex flex-col items-center gap-2 transition-all";
                btnZen.className = "p-3 rounded-lg border bg-slate-800 border-slate-700 text-slate-500 flex flex-col items-center gap-2 transition-all hover:bg-slate-700";
            } else {
                btnZen.className = "p-3 rounded-lg border bg-sky-500/20 border-sky-500 text-white flex flex-col items-center gap-2 transition-all";
                btnList.className = "p-3 rounded-lg border bg-slate-800 border-slate-700 text-slate-500 flex flex-col items-center gap-2 transition-all hover:bg-slate-700";
            }
        }
        function changeLimit(delta) {
            let newVal = state.limit + delta;
            if (newVal < 5) newVal = 5; if (newVal > state.filteredQuestions.length) newVal = state.filteredQuestions.length; if (state.filteredQuestions.length === 0) newVal = 0;
            state.limit = newVal; document.getElementById('q-limit-input').value = newVal;
        }
        function manualLimitChange(val) {
            let num = parseInt(val); if (!num || num < 1) num = 5; state.limit = num; updateCounter();
        }

        // --- FILTRAGEM ---
        function updateCounter() {
            const filtered = state.db.filter(q => {
                if (q.cycle !== state.cycle) return false;
                if (state.usePBL) {
                    if (state.pblModules.length > 0 && !state.pblModules.includes(q.pblModule)) return false;
                    if (!state.pblModules.length && !q.pblModule) return false;
                } else {
                    if (state.disciplines.length > 0) {
                        if (!state.disciplines.includes(q.discipline)) return false;
                        if (state.subTopics.length > 0 && !state.subTopics.includes(q.subTopic)) return false;
                    }
                }
                if (!state.filters.unanswered && q.status === 'unanswered') return false;
                return true;
            });
            state.filteredQuestions = filtered;
            document.getElementById('q-counter').innerText = filtered.length;
            const btn = document.getElementById('btn-generate');
            if (filtered.length > 0) {
                btn.disabled = false;
                btn.className = "w-full py-4 rounded-xl font-bold text-base flex items-center justify-center gap-2 transition-all shadow-lg bg-sky-500 hover:bg-sky-400 text-white hover:shadow-sky-500/25 hover:-translate-y-1 cursor-pointer";
                if (state.limit > filtered.length) state.limit = filtered.length;
                if (state.limit === 0) state.limit = Math.min(10, filtered.length);
                document.getElementById('q-limit-input').value = state.limit;
            } else {
                btn.disabled = true;
                btn.className = "w-full py-4 rounded-xl font-bold text-base flex items-center justify-center gap-2 transition-all shadow-lg bg-slate-800 text-slate-500 cursor-not-allowed";
                state.limit = 0;
                document.getElementById('q-limit-input').value = 0;
            }
        }

        // --- EXAM LOGIC & INTERACTIVITY ---
        function shuffle(array) { return array.sort(() => Math.random() - 0.5); }

        function startExam() {
            let pool = shuffle([...state.filteredQuestions]);
            state.examQuestions = pool.slice(0, state.limit);
            state.currentZenIndex = 0;
            state.eliminatedOptions = {};
            state.userAnswers = {}; 

            document.getElementById('dashboard-view').classList.add('hidden');
            document.getElementById('exam-view').classList.remove('hidden');
            document.getElementById('header-logo-area').onclick = null;
            document.getElementById('nav-dashboard').classList.add('hidden');
            document.getElementById('nav-exam').classList.remove('hidden');
            document.getElementById('nav-exam').classList.add('flex');

            renderQuestions();
            updateZenUI();
            
            // Subir automaticamente ao iniciar
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function exitExam() {
            if(confirm('Deseja sair do caderno? O progresso não salvo será perdido.')) resetToDashboard();
        }

        function resetToDashboard() {
            document.getElementById('dashboard-view').classList.remove('hidden');
            document.getElementById('exam-view').classList.add('hidden');
            document.getElementById('nav-dashboard').classList.remove('hidden');
            document.getElementById('nav-exam').classList.add('hidden');
            document.getElementById('nav-exam').classList.remove('flex');
            document.getElementById('header-logo-area').onclick = resetToDashboard;
            
            // Subir automaticamente ao voltar
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function toggleElimination(qId, optIdx) {
            if (!state.eliminatedOptions[qId]) state.eliminatedOptions[qId] = [];
            const list = state.eliminatedOptions[qId];
            if (list.includes(optIdx)) state.eliminatedOptions[qId] = list.filter(i => i !== optIdx); else state.eliminatedOptions[qId].push(optIdx);
            
            const qIndex = state.examQuestions.findIndex(q => q.id === qId);
            refreshQuestionCard(qId, qIndex);
        }

        function selectOption(qId, index) {
            if (state.userAnswers[qId]?.submitted) return;

            if (!state.userAnswers[qId]) state.userAnswers[qId] = { selected: null, submitted: false };
            state.userAnswers[qId].selected = index;

            const qIndex = state.examQuestions.findIndex(q => q.id === qId);
            refreshQuestionCard(qId, qIndex);
        }

        function submitAnswer(qId) {
            if (!state.userAnswers[qId] || state.userAnswers[qId].selected === null) {
                alert("Por favor, selecione uma alternativa antes de responder.");
                return;
            }
            state.userAnswers[qId].submitted = true;
            
            const qIndex = state.examQuestions.findIndex(q => q.id === qId);
            refreshQuestionCard(qId, qIndex);
        }

        function refreshQuestionCard(qId, index) {
            const q = state.examQuestions.find(q => q.id === qId);
            const container = document.getElementById(`q-card-${qId}`);
            if (container) {
                container.outerHTML = renderQuestionHTML(q, index);
                lucide.createIcons();
            }
        }

        function renderQuestionHTML(q, index) {
            const letters = ['A', 'B', 'C', 'D', 'E'];
            const eliminated = state.eliminatedOptions[q.id] || [];
            
            const answerState = state.userAnswers[q.id] || { selected: null, submitted: false };
            const { selected, submitted } = answerState;

            return `
                <div class="bg-slate-800/50 border border-slate-700 rounded-2xl p-6 md:p-8 shadow-2xl relative fade-in" id="q-card-${q.id}">
                    <div class="flex justify-between items-start mb-6 border-b border-slate-700/50 pb-4">
                        <div class="flex flex-col gap-2">
                            <div class="flex items-center gap-2 flex-wrap">
                                <span class="px-2 py-1 rounded bg-slate-700 text-slate-300 text-xs font-bold border border-slate-600">${q.discipline}</span>
                                <span class="px-2 py-1 rounded bg-sky-900/30 text-sky-400 text-xs font-bold border border-sky-500/20">${q.subTopic}</span>
                            </div>
                            <h3 class="text-slate-400 text-sm font-mono mt-1">Questão #${q.id}</h3>
                        </div>
                        <div class="flex items-center gap-2">
                             ${q.difficulty === 'facil' ? '<span class="text-xs font-bold text-green-400 bg-green-400/10 px-2 py-1 rounded">Fácil</span>' : ''}
                             ${q.difficulty === 'media' ? '<span class="text-xs font-bold text-yellow-400 bg-yellow-400/10 px-2 py-1 rounded">Média</span>' : ''}
                             ${q.difficulty === 'dificil' ? '<span class="text-xs font-bold text-red-400 bg-red-400/10 px-2 py-1 rounded">Difícil</span>' : ''}
                        </div>
                    </div>

                    <div class="mb-8">
                        <p class="text-lg text-slate-200 leading-relaxed font-medium">
                            <span class="text-slate-500 font-bold mr-2">${index + 1}.</span> ${q.text}
                        </p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="options-container-${q.id}">
                        ${q.options.map((opt, i) => {
                            const isElim = eliminated.includes(i);
                            const isSelected = selected === i;
                            const isCorrect = i === q.correctIndex;
                            
                            let cardClasses = "relative p-4 rounded-xl border transition-all flex items-start gap-4 group cursor-pointer ";
                            let letterClasses = "w-8 h-8 min-w-[2rem] rounded-full border flex items-center justify-center font-bold transition-colors ";
                            let textClasses = "text-sm md:text-base leading-relaxed flex-1 ";
                            
                            if (!submitted) {
                                if (isElim) {
                                    cardClasses += "bg-slate-900/30 border-slate-800 opacity-60 option-eliminated";
                                    letterClasses += "border-slate-700 text-slate-600";
                                    textClasses += "line-through text-slate-600";
                                } else if (isSelected) {
                                    cardClasses += "bg-sky-500/10 border-sky-500 shadow-sm";
                                    letterClasses += "bg-sky-500 border-sky-500 text-white";
                                    textClasses += "text-white font-medium";
                                } else {
                                    cardClasses += "bg-slate-800/50 border-slate-700 hover:bg-slate-700/50 hover:border-slate-500";
                                    letterClasses += "border-slate-600 text-slate-400 group-hover:border-sky-500 group-hover:text-sky-500";
                                    textClasses += "text-slate-300 group-hover:text-white";
                                }
                            } 
                            else {
                                if (isCorrect) {
                                    cardClasses += "opt-correct";
                                    textClasses += "text-green-100 font-medium";
                                } else if (isSelected && !isCorrect) {
                                    cardClasses += "opt-wrong";
                                    textClasses += "text-red-100";
                                } else {
                                    cardClasses += "bg-slate-900/40 border-slate-800 opacity-50";
                                    letterClasses += "border-slate-700 text-slate-600";
                                    textClasses += "text-slate-500";
                                }
                            }

                            return `
                                <div id="opt-${q.id}-${i}" 
                                     onclick="selectOption('${q.id}', ${i})"
                                     class="${cardClasses}">
                                    
                                    <div class="opt-letter ${letterClasses}">
                                        ${letters[i]}
                                    </div>
                                    
                                    <p class="opt-text ${textClasses}">
                                        ${opt}
                                    </p>

                                    ${!submitted ? `
                                    <button onclick="event.stopPropagation(); toggleElimination('${q.id}', ${i})" 
                                            class="eye-btn absolute top-2 right-2 p-1.5 rounded-full transition-all text-slate-600 hover:text-red-400 hover:bg-slate-700 ${isElim ? 'text-red-500 bg-red-500/10' : ''}">
                                        <i data-lucide="${isElim ? 'eye-off' : 'eye'}" class="eye-icon w-4 h-4"></i>
                                    </button>
                                    ` : ''}
                                </div>
                            `
                        }).join('')}
                    </div>

                    <div class="mt-8 pt-6 border-t border-slate-700/50">
                        ${!submitted ? `
                            <div class="flex justify-end gap-3">
                                <button onclick="submitAnswer('${q.id}')" 
                                        class="bg-sky-600 hover:bg-sky-500 text-white px-8 py-2.5 rounded-lg font-bold shadow-lg shadow-sky-900/20 transition-all">
                                    Responder
                                </button>
                            </div>
                        ` : `
                            <div class="fade-in animate-in slide-in-from-top-2">
                                <div class="bg-slate-900/60 border border-slate-700/50 rounded-xl p-5 relative overflow-hidden">
                                    <div class="absolute left-0 top-0 bottom-0 w-1 ${selected === q.correctIndex ? 'bg-green-500' : 'bg-red-500'}"></div>
                                    <h4 class="text-sm font-bold uppercase tracking-wider mb-2 ${selected === q.correctIndex ? 'text-green-400' : 'text-red-400'}">
                                        ${selected === q.correctIndex ? 'Resposta Correta!' : 'Resposta Incorreta'}
                                    </h4>
                                    <p class="text-slate-300 text-sm leading-relaxed">
                                        ${q.rationale}
                                    </p>
                                </div>
                            </div>
                        `}
                    </div>
                </div>
            `;
        }

        function renderQuestions() {
            const container = document.getElementById('questions-container');
            const label = document.getElementById('exam-mode-label');
            if (state.viewMode === 'list') {
                label.innerText = 'Lista Completa';
                document.getElementById('zen-controls').classList.add('hidden');
                document.getElementById('zen-progress-container').classList.add('hidden');
                container.innerHTML = state.examQuestions.map((q, i) => renderQuestionHTML(q, i)).join('<div class="h-8"></div>');
            } else {
                label.innerText = 'Modo Zen';
                document.getElementById('zen-controls').classList.remove('hidden');
                document.getElementById('zen-progress-container').classList.remove('hidden');
                const q = state.examQuestions[state.currentZenIndex];
                container.innerHTML = renderQuestionHTML(q, state.currentZenIndex);
            }
            lucide.createIcons();
            updateZenUI();
        }

        function updateZenUI() {
            if (state.viewMode !== 'zen') return;
            const percent = ((state.currentZenIndex + 1) / state.examQuestions.length) * 100;
            document.getElementById('zen-progress-bar').style.width = `${percent}%`;
            document.getElementById('zen-current-q').innerText = `Questão ${state.currentZenIndex + 1}`;
            document.getElementById('zen-total-q').innerText = `de ${state.examQuestions.length}`;
            document.getElementById('zen-counter').innerText = `${state.currentZenIndex + 1} / ${state.examQuestions.length}`;
            document.getElementById('btn-zen-prev').disabled = state.currentZenIndex === 0;
            document.getElementById('btn-zen-next').disabled = state.currentZenIndex === state.examQuestions.length - 1;
        }

        function zenNext() { if (state.currentZenIndex < state.examQuestions.length - 1) { state.currentZenIndex++; renderQuestions(); window.scrollTo(0,0); } }
        function zenPrev() { if (state.currentZenIndex > 0) { state.currentZenIndex--; renderQuestions(); window.scrollTo(0,0); } }

        // --- PDF GENERATION WITH LOGO ---
        // Helper to fetch image and convert to Data URL
        function getImageDataUrl(url) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = "Anonymous"; // Try to handle CORS
                img.src = url;
                img.onload = () => {
                    const canvas = document.createElement("canvas");
                    canvas.width = img.width;
                    canvas.height = img.height;
                    const ctx = canvas.getContext("2d");
                    ctx.drawImage(img, 0, 0);
                    resolve(canvas.toDataURL("image/png"));
                };
                img.onerror = (e) => {
                    console.warn("Could not load image for PDF", e);
                    resolve(null); // Fallback if image fails
                };
            });
        }

        async function downloadPDF() {
            if (!window.jspdf) {
                alert("Erro: Biblioteca PDF ainda carregando. Tente novamente em alguns segundos.");
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            const margin = 20;
            let y = 30; // Posição vertical inicial
            
            // 1. Fetch Logo (ATUALIZADO)
            const logoUrl = "https://raw.githubusercontent.com/acervo450-commits/mednexus/main/Banco%20de%20Quest%C3%B5es/BQ.png";
            const logoData = await getImageDataUrl(logoUrl);

            // Função para adicionar Marca D'água, Logo e Cabeçalho em cada página
            function addPageDecorations() {
                // Marca D'água
                doc.saveGraphicsState();
                doc.setTextColor(230, 230, 230); // Cinza bem claro
                doc.setFontSize(60);
                doc.setFont("helvetica", "bold");
                // Rotaciona e centraliza
                doc.text("MEDNEXUS", pageWidth / 2, pageHeight / 2, { align: "center", angle: 45 });
                doc.restoreGraphicsState();

                // Cabeçalho
                if (logoData) {
                    // Add Image Logo
                    const imgWidth = 30; // mm
                    const imgHeight = 10; // approximate aspect ratio
                    doc.addImage(logoData, 'PNG', margin, 10, imgWidth, imgHeight);
                } else {
                    // Fallback Text if image fails
                    doc.setFontSize(14);
                    doc.setTextColor(0, 102, 204);
                    doc.setFont("helvetica", "bold");
                    doc.text("MEDNEXUS", margin, 18);
                }

                doc.setFontSize(10);
                doc.setTextColor(100);
                doc.setFont("helvetica", "normal");
                const headerText = "Banco de Questões Personalizado";
                const textWidth = doc.getTextWidth(headerText);
                doc.text(headerText, pageWidth - margin - textWidth, 18);
                
                doc.setDrawColor(200);
                doc.line(margin, 22, pageWidth - margin, 22);
            }

            // Inicia o documento
            addPageDecorations();
            
            // Título do Caderno
            y = 35;
            doc.setFontSize(18);
            doc.setTextColor(0); // Preto
            doc.setFont("helvetica", "bold");
            doc.text("Caderno de Questões", margin, y);
            y += 15;

            state.examQuestions.forEach((q, i) => {
                // Verifica se cabe na página (estimativa), senão cria nova
                if (y > pageHeight - 50) {
                    doc.addPage();
                    addPageDecorations();
                    y = 35;
                }

                // Número e Disciplina da Questão
                doc.setFontSize(12);
                doc.setFont("helvetica", "bold");
                doc.setTextColor(0, 102, 204); // Azul MedNexus
                doc.text(`Questão ${i + 1} - ${q.discipline} (${q.subTopic})`, margin, y);
                y += 8;

                // Enunciado
                doc.setFontSize(11);
                doc.setFont("helvetica", "normal");
                doc.setTextColor(0);
                const splitText = doc.splitTextToSize(q.text, pageWidth - (margin * 2));
                doc.text(splitText, margin, y);
                y += (splitText.length * 6) + 5;

                // Alternativas
                q.options.forEach((opt, idx) => {
                    // Verifica quebra de página dentro das alternativas
                    if (y > pageHeight - 20) {
                        doc.addPage();
                        addPageDecorations();
                        y = 35;
                    }

                    const letter = String.fromCharCode(65 + idx);
                    const optText = `(   )  ${letter}) ${opt}`;
                    const splitOpt = doc.splitTextToSize(optText, pageWidth - (margin * 2) - 5);
                    
                    doc.text(splitOpt, margin + 5, y);
                    y += (splitOpt.length * 6) + 2;
                });

                y += 10; // Espaço entre questões
                
                // Linha separadora suave
                doc.setDrawColor(240);
                doc.line(margin, y - 5, pageWidth - margin, y - 5);
            });

            // Rodapé com data
            const date = new Date().toLocaleDateString('pt-BR');
            doc.setFontSize(8);
            doc.setTextColor(150);
            doc.text(`Gerado em ${date} via MEDNEXUS`, margin, pageHeight - 10);

            doc.save("caderno_mednexus.pdf");
        }

        // --- SCROLL TO TOP LOGIC ---
        window.onscroll = function() {
            const btn = document.getElementById('btn-back-to-top');
            if (document.body.scrollTop > 300 || document.documentElement.scrollTop > 300) {
                btn.classList.remove('hidden-scroll');
            } else {
                btn.classList.add('hidden-scroll');
            }
        };

        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        window.onload = init;
    </script>
</body>
</html>
