<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MEDNEXUS - Banco de Questões</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- jsPDF Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <!-- Configuração Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        slate: {
                            850: '#151e32',
                            900: '#0f172a',
                            950: '#020617',
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* Estilos Customizados */
        body {
            background-color: #0f172a;
            color: #cbd5e1;
            -webkit-font-smoothing: antialiased;
        }
        
        /* Scrollbar personalizada */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #0f172a;
        }
        ::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #475569;
        }

        /* Animações simples */
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        .slide-up {
            animation: slideUp 0.4s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .active-cycle {
            background-color: rgba(14, 165, 233, 0.1);
            border-color: #0ea5e9;
            box-shadow: 0 10px 15px -3px rgba(12, 74, 110, 0.2);
        }
        .active-cycle h3 { color: white; }
        .active-cycle .icon-box { background-color: #0ea5e9; color: white; }

        .chip-selected {
            background-color: #0284c7;
            color: white;
            border-color: #0ea5e9;
        }
        
        .option-eliminated {
            opacity: 0.5;
            text-decoration: line-through;
            background-color: rgba(15, 23, 42, 0.5);
        }

        /* Estilos de Feedback */
        .opt-correct {
            background-color: rgba(34, 197, 94, 0.15) !important;
            border-color: #22c55e !important;
        }
        .opt-correct .opt-letter {
            background-color: #22c55e;
            border-color: #22c55e;
            color: white;
        }
        
        .opt-wrong {
            background-color: rgba(239, 68, 68, 0.15) !important;
            border-color: #ef4444 !important;
        }
        .opt-wrong .opt-letter {
            background-color: #ef4444;
            border-color: #ef4444;
            color: white;
        }
    </style>
</head>
<body class="selection:bg-sky-500/30">

    <!-- HEADER (Fixo) -->
    <header class="fixed top-0 w-full z-50 bg-slate-900/90 backdrop-blur-md border-b border-slate-800">
        <div class="max-w-[1400px] mx-auto px-4 md:px-6 h-16 flex items-center justify-between">
            <!-- Logo & Nav -->
            <div class="flex items-center gap-4">
                <div id="header-logo-area" class="flex items-center gap-2 cursor-pointer" onclick="resetToDashboard()">
                    <div class="w-8 h-8 bg-gradient-to-br from-sky-500 to-blue-700 rounded-lg flex items-center justify-center shadow-lg shadow-sky-500/20">
                        <i data-lucide="activity" class="text-white w-5 h-5"></i>
                    </div>
                    <span class="text-xl font-bold bg-gradient-to-r from-white to-slate-400 bg-clip-text text-transparent tracking-tight hidden sm:block">
                        MEDNEXUS
                    </span>
                </div>
                
                <div class="h-6 w-px bg-slate-800 mx-2 hidden sm:block"></div>
                
                <div id="nav-dashboard" class="flex items-center gap-2 text-sm">
                    <span class="text-sky-500 font-semibold bg-sky-500/10 px-3 py-1 rounded-full border border-sky-500/20">
                        Banco de Questões
                    </span>
                </div>

                <div id="nav-exam" class="hidden items-center gap-4 w-full">
                    <button onclick="exitExam()" class="flex items-center gap-2 text-slate-400 hover:text-white transition-colors">
                        <i data-lucide="arrow-left" class="w-5 h-5"></i>
                        <span class="font-medium">Sair</span>
                    </button>
                    
                    <div id="zen-progress-container" class="hidden flex-1 max-w-md mx-4 md:block">
                        <div class="flex justify-between text-xs text-slate-400 mb-1">
                            <span id="zen-current-q">Questão 1</span>
                            <span id="zen-total-q">de 10</span>
                        </div>
                        <div class="h-1.5 w-full bg-slate-800 rounded-full overflow-hidden">
                            <div id="zen-progress-bar" class="h-full bg-sky-500 transition-all duration-300" style="width: 0%"></div>
                        </div>
                    </div>

                    <button onclick="downloadPDF()" class="ml-auto flex items-center gap-2 px-3 py-1.5 bg-slate-800 hover:bg-slate-700 text-slate-300 rounded-lg border border-slate-700 transition-all text-sm">
                        <i data-lucide="download" class="w-4 h-4"></i>
                        <span class="hidden sm:inline">Baixar PDF</span>
                    </button>
                </div>
            </div>

            <!-- User Profile -->
            <div class="flex items-center gap-4">
                <div class="text-right hidden sm:block">
                    <p class="text-sm text-white font-medium">Dr. Rafael</p>
                    <p class="text-xs text-slate-500">Plano Extensivo 2024</p>
                </div>
                <div class="w-9 h-9 rounded-full bg-slate-700 border border-slate-600 flex items-center justify-center text-xs font-bold text-white">
                    DR
                </div>
            </div>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main class="pt-24 pb-12 px-4 md:px-6 max-w-[1400px] mx-auto min-h-screen">
        
        <!-- DASHBOARD VIEW -->
        <div id="dashboard-view" class="grid grid-cols-1 lg:grid-cols-3 gap-8 fade-in">
            <!-- Coluna Esquerda: Configurações -->
            <div class="lg:col-span-2 space-y-8 pb-20 lg:pb-0">
                <div class="mb-6 flex justify-between items-end flex-wrap gap-4">
                    <div>
                        <h1 class="text-3xl font-bold text-white mb-2">Configure seu Treino</h1>
                        <p class="text-slate-400">Base de dados atualizada: <span class="text-sky-400 font-mono font-bold" id="total-db-count">0</span> questões disponíveis.</p>
                    </div>
                    <div class="hidden md:flex items-center gap-2 px-3 py-1.5 bg-green-500/10 border border-green-500/20 rounded-full">
                        <i data-lucide="database" class="w-3.5 h-3.5 text-green-500"></i>
                        <span class="text-xs font-medium text-green-400">Banco Atualizado</span>
                    </div>
                </div>

                <section>
                    <div class="flex items-center gap-2 mb-4 text-sky-400">
                        <i data-lucide="layers" class="w-4.5 h-4.5"></i>
                        <h2 class="text-sm font-bold uppercase tracking-wider">1. Escolha o Ciclo</h2>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4" id="cycles-container"></div>
                </section>

                <section class="bg-slate-800/20 border border-slate-800 rounded-2xl p-6 relative overflow-hidden transition-all">
                    <div class="absolute top-0 right-0 w-64 h-64 bg-slate-800/20 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2 pointer-events-none"></div>
                    <div class="flex items-center justify-between mb-6 relative z-10 flex-wrap gap-4">
                        <div class="flex items-center gap-2 text-sky-400">
                            <i data-lucide="book-open" class="w-4.5 h-4.5"></i>
                            <h2 class="text-sm font-bold uppercase tracking-wider">2. Conteúdo</h2>
                        </div>
                        <div class="flex items-center gap-2 bg-slate-900/50 p-1 rounded-lg border border-slate-700/50">
                            <button onclick="setMode('traditional')" id="btn-mode-trad" class="px-3 py-1.5 text-xs font-medium rounded-md transition-all bg-slate-700 text-white shadow">Tradicional</button>
                            <button onclick="setMode('pbl')" id="btn-mode-pbl" class="px-3 py-1.5 text-xs font-medium rounded-md transition-all text-slate-500 hover:text-slate-300">PBL (Tutoria)</button>
                        </div>
                    </div>
                    <div id="content-area" class="relative z-10"></div>
                </section>
            </div>

            <!-- Coluna Direita: Resumo Sticky -->
            <div class="lg:col-span-1">
                <div class="sticky top-24 space-y-4">
                    <div class="bg-slate-850 border border-slate-800 rounded-2xl overflow-hidden shadow-xl">
                        <div class="p-4 border-b border-slate-800 bg-slate-900/50">
                            <div class="flex items-center gap-2 text-slate-300">
                                <i data-lucide="settings" class="w-4.5 h-4.5"></i>
                                <span class="font-semibold text-sm">Filtros da Prova</span>
                            </div>
                        </div>
                        <div class="p-5 space-y-4">
                            <div>
                                <h4 class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-3">Status</h4>
                                <div class="space-y-1" id="status-filters"></div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-gradient-to-br from-sky-900/20 to-slate-850 border border-sky-500/20 rounded-2xl p-6 shadow-2xl relative overflow-hidden">
                        <div class="absolute -top-10 -right-10 w-32 h-32 bg-sky-500/10 rounded-full blur-3xl"></div>
                        <div class="text-center mb-6 relative z-10">
                            <span class="text-slate-400 text-sm font-medium">Questões Encontradas</span>
                            <div id="q-counter" class="text-5xl font-bold text-white mt-1 tracking-tighter tabular-nums transition-all">0</div>
                            <p class="text-xs text-sky-400 mt-2 font-medium">Baseado na sua seleção</p>
                        </div>
                        <div class="mb-4 relative z-10">
                            <label class="block text-xs font-semibold text-slate-400 mb-2 uppercase tracking-wider text-center">Modo de Exibição</label>
                            <div class="grid grid-cols-2 gap-3">
                                <button onclick="setViewMode('list')" id="btn-view-list" class="p-3 rounded-lg border bg-sky-500/20 border-sky-500 text-white flex flex-col items-center gap-2 transition-all">
                                    <i data-lucide="layout-list" class="w-5 h-5"></i>
                                    <span class="text-[10px] font-bold uppercase">Lista</span>
                                </button>
                                <button onclick="setViewMode('zen')" id="btn-view-zen" class="p-3 rounded-lg border bg-slate-800 border-slate-700 text-slate-500 flex flex-col items-center gap-2 transition-all hover:bg-slate-700">
                                    <i data-lucide="maximize" class="w-5 h-5"></i>
                                    <span class="text-[10px] font-bold uppercase">Zen Mode</span>
                                </button>
                            </div>
                        </div>
                        <div class="mb-4 bg-slate-900/40 rounded-lg p-3 border border-sky-500/10 backdrop-blur-sm relative z-10">
                            <div class="flex items-center justify-center gap-3">
                                <button onclick="changeLimit(-5)" class="p-1.5 rounded-md bg-slate-800 border border-slate-700 hover:text-white text-slate-400"><i data-lucide="minus" class="w-4 h-4"></i></button>
                                <div class="relative">
                                    <input type="number" id="q-limit-input" value="10" class="w-16 bg-transparent text-center text-white font-bold outline-none text-lg appearance-none" onchange="manualLimitChange(this.value)">
                                    <span class="absolute right-0 top-2 text-[10px] text-slate-600 pointer-events-none">Qts</span>
                                </div>
                                <button onclick="changeLimit(5)" class="p-1.5 rounded-md bg-slate-800 border border-slate-700 hover:text-white text-slate-400"><i data-lucide="plus" class="w-4 h-4"></i></button>
                            </div>
                        </div>
                        <button onclick="startExam()" id="btn-generate" class="w-full py-4 rounded-xl font-bold text-base flex items-center justify-center gap-2 transition-all shadow-lg bg-slate-800 text-slate-500 cursor-not-allowed" disabled>
                            <i data-lucide="play" class="w-4 h-4 fill-current"></i>
                            GERAR CADERNO
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- EXAM VIEW (Hidden by default) -->
        <div id="exam-view" class="hidden fade-in max-w-4xl mx-auto">
            <div id="exam-header" class="text-center mb-8">
                <h2 class="text-2xl font-bold text-white">Caderno de Questões</h2>
                <p class="text-slate-400 text-sm">Modo: <span id="exam-mode-label" class="text-sky-400 font-bold">Lista</span></p>
            </div>
            <div id="questions-container" class="space-y-6"></div>
            <div id="zen-controls" class="hidden fixed bottom-0 left-0 w-full bg-slate-900/95 backdrop-blur border-t border-slate-800 p-4 z-40">
                <div class="max-w-4xl mx-auto flex items-center justify-between">
                    <button onclick="zenPrev()" id="btn-zen-prev" class="flex items-center gap-2 px-6 py-3 rounded-xl font-bold text-slate-300 hover:bg-slate-800 transition-colors disabled:opacity-50">
                        <i data-lucide="chevron-left"></i> Anterior
                    </button>
                    <span id="zen-counter" class="text-slate-500 font-mono text-sm">1 / 10</span>
                    <button onclick="zenNext()" id="btn-zen-next" class="flex items-center gap-2 px-6 py-3 rounded-xl font-bold bg-sky-600 hover:bg-sky-500 text-white shadow-lg transition-all disabled:opacity-50">
                        Próxima <i data-lucide="chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- SCRIPTS LÓGICA DO APP -->
    <script>
        // --- 1. DADOS (Config) ---
        const CYCLES = [
            { id: 'basico', label: 'Ciclo Básico', icon: 'beaker', description: 'Fundamentos biomédicos' },
            { id: 'clinico', label: 'Ciclo Clínico', icon: 'stethoscope', description: 'Patologias e semiologia' },
            { id: 'internato', label: 'Internato', icon: 'graduation-cap', description: 'Prática e conduta médica' },
        ];

        const DISCIPLINES = {
            basico: ['Anatomia', 'Fisiologia', 'Histologia', 'Bioquímica', 'Embriologia', 'Imunologia', 'Genética', 'Patologia Geral'],
            clinico: ['Cardiologia', 'Pneumologia', 'Gastroenterologia', 'Nefrologia', 'Neurologia', 'Infectologia', 'Reumatologia', 'Endocrinologia', 'Hematologia', 'Psiquiatria'],
            internato: ['Clínica Médica', 'Cirurgia Geral', 'Pediatria', 'Ginecologia e Obstetrícia', 'Medicina Preventiva', 'Medicina de Família', 'Urgência e Emergência']
        };

        const SUB_TOPICS = {
            'Anatomia': ['Sistema Esquelético', 'Sistema Muscular', 'Neuroanatomia', 'Sistema Circulatório', 'Sistema Respiratório', 'Sistema Digestório'],
            'Fisiologia': ['Fisiologia Celular', 'Neurofisiologia', 'Cardiovascular', 'Respiratória', 'Renal', 'Endocrinologia'],
            'Cardiologia': ['Hipertensão', 'Insuficiência Cardíaca', 'Arritmias', 'Valvopatias', 'DAC']
        };

        const PBL_MODULES = [
            'Mód. 1 - Concepção', 'Mód. 2 - Agressão e Defesa', 'Mód. 3 - Metabolismo', 'Mód. 4 - Cardiovascular',
            'Mód. 5 - Respiratório', 'Mód. 6 - Mental', 'Mód. 7 - Locomoção', 'Mód. 8 - Envelhecimento'
        ];

        // --- BASE DE DADOS PREENCHIDA COM INPUT DO USUÁRIO ---
        const REAL_QUESTIONS = [
            {
                id: '1001', cycle: 'basico', discipline: 'Anatomia', subTopic: 'Neuroanatomia',
                text: 'A inervação da língua é rica e bem variada quanto à sua porção motora e sensitiva, com diferenças entre a geral – tato e temperatura – e específica – paladar. Assinale a alternativa que contenha o principal nervo responsável pela motricidade da língua e pela sensibilidade especial dos dois terços anteriores.',
                options: [
                    'N. hipoglosso e n. corda do tímpano.',
                    'N. hipoglosso e n. facial.',
                    'N. glossofaríngeo e n. hipoglosso.',
                    'N. glossofaríngeo e n. corda do tímpano.',
                    'N. hipoglosso e n. lingual.'
                ],
                correctIndex: 0,
                difficulty: 'media', status: 'unanswered',
                rationale: 'O nervo hipoglosso (NC XII) é o principal motor da língua. A sensibilidade especial (paladar) dos 2/3 anteriores é realizada pelo nervo corda do tímpano (ramo do NC VII - Facial).'
            },
            {
                id: '1002', cycle: 'basico', discipline: 'Anatomia', subTopic: 'Sistema Circulatório',
                text: 'A língua apresenta uma rica vascularização necessária para o funcionamento adequado da musculatura que controla os seus movimentos. Qual é a artéria responsável pela irrigação da raiz da língua?',
                options: [
                    'A. sublingual.',
                    'A. profunda da língua.',
                    'A. lingual.',
                    'Aa. dorsais da língua.',
                    'A. sublingual e a. profunda da língua.'
                ],
                correctIndex: 3,
                difficulty: 'dificil', status: 'unanswered',
                rationale: 'As artérias dorsais da língua (ramos da a. lingual) são responsáveis por vascularizar a raiz da língua e a tonsila palatina.'
            },
            {
                id: '1003', cycle: 'basico', discipline: 'Anatomia', subTopic: 'Sistema Muscular',
                text: 'A musculatura intrínseca da língua é importante, em especial, na alteração do formato da língua porque eles não se inserem em ossos. Assinale a alternativa incorreta acerca deles.',
                options: [
                    'O músculo longitudinal superior está localizado inferiormente à túnica mucosa do dorso da língua, curvando a língua longitudinalmente para cima e elevando o seu ápice.',
                    'O músculo transverso está localizado inferiormente ao longitudinal superior e suas fibras estão dispostas no eixo laterolateral da língua.',
                    'O músculo vertical tem suas fibras interpostas com o transverso e atua no achatamento da língua.',
                    'O músculo longitudinal inferior está localizado inferiormente ao longitudinal superior e tem as mesmas funções.',
                    'A atuação conjunta dos músculos vertical e transverso resulta em um alongamento e estreitamento da língua, podendo empurrá-la contra os dentes incisivos.'
                ],
                correctIndex: 3,
                difficulty: 'media', status: 'unanswered',
                rationale: 'A alternativa D está incorreta porque o músculo longitudinal inferior encurta a língua e abaixa o ápice, enquanto o superior eleva o ápice.'
            },
            {
                id: '1004', cycle: 'basico', discipline: 'Anatomia', subTopic: 'Sistema Muscular',
                text: 'A musculatura extrínseca da língua é importante em especial na alteração de sua posição e eles se originam a partir de um osso. Assinale a alternativa correta acerca deles.',
                options: [
                    'O músculo genioglosso é o único que não é inervado pelo nervo hipoglosso (NC XII), mas apresenta importante função como músculo longitudinal interno.',
                    'O músculo genioglosso ocupa um espaço relativamente pequeno da língua e insere-se na espinha geniculada da mandíbula.',
                    'O músculo hioglosso insere-se na região lateral da língua e atua para a sua protusão e elevação de suas laterais.',
                    'O músculo estiloglosso tem origem no processo estiloide e insere-se lateralmente na língua, auxiliando na elevação de suas laterais e retração.',
                    'O principal músculo extrínseco é o longitudinal superior, que atua para curvar a língua longitudinalmente para cima.'
                ],
                correctIndex: 3,
                difficulty: 'media', status: 'unanswered',
                rationale: 'O estiloglosso origina-se no processo estiloide e atua retraindo a língua e elevando suas laterais.'
            },
            {
                id: '1005', cycle: 'basico', discipline: 'Anatomia', subTopic: 'Sistema Muscular',
                text: 'A língua é, essencialmente, um órgão muscular recoberto por uma túnica mucosa. Essa característica faz com que a sua musculatura seja um componente muito importante para a sua função. Assinale a alternativa correta acerca da musculatura lingual.',
                options: [
                    'Há a musculatura extrínseca da língua formada por músculos que se originam exteriormente e a sua única função é de mudança do formato da língua.',
                    'A principal função dos músculos intrínsecos da língua é a alteração de sua posição.',
                    'O funcionamento dos músculos da língua é complexo e não podem ser resumidos a ações simples, podendo ter funções diferentes e antagônicas em suas partes.',
                    'Um dos músculos intrínsecos é o genioglosso, que compõe a maior parte da língua e apresenta formato de leque.',
                    'Um dos músculos extrínsecos é o longitudinal superior, que constitui à camada fina de músculos orientada longitudinalmente localizada abaixo da túnica mucosa no dorso da língua.'
                ],
                correctIndex: 2,
                difficulty: 'facil', status: 'unanswered',
                rationale: 'A musculatura lingual é complexa, com ações combinadas para movimentos precisos da fala e deglutição, não se limitando a ações isoladas simples.'
            },
            {
                id: '1006', cycle: 'basico', discipline: 'Anatomia', subTopic: 'Sistema Digestório',
                text: 'Qual das estruturas abaixo corresponde a uma projeção existente na túnica mucosa do assoalho da cavidade oral abaixo da face inferior da língua? Essa estrutura está associada ao frênulo lingual e apresenta o óstio do ducto salivar submandibular.',
                options: [
                    'Sulco terminal da língua.',
                    'Sulco mediano.',
                    'Papila sublingual.',
                    'Papilas circunvaladas.',
                    'Papilas fungiformes.'
                ],
                correctIndex: 2,
                difficulty: 'facil', status: 'unanswered',
                rationale: 'A papila sublingual (ou carúncula sublingual) é onde se abrem os ductos das glândulas submandibulares.'
            },
            {
                id: '1007', cycle: 'basico', discipline: 'Anatomia', subTopic: 'Sistema Respiratório',
                text: 'O palato mole fica suspenso e tem a sua posição controlada pela ação de músculos, que permitem com que ele bloqueie a comunicação entre as cavidades provisoriamente. Assinale a alternativa incorreta acerca desse tópico.',
                options: [
                    'O palato mole bloqueia, durante a deglutição, a comunicação entre a orofaringe e a nasofaringe.',
                    'O músculo palatoglosso forma o arco palatino mais anterior e é um dos músculos extrínsecos da língua.',
                    'O músculo palatofaríngeo forma o arco palatino mais posterior e atua como um músculo longitudinal da faringe.',
                    'O músculo tensor do véu palatino também age na abertura da tuba auditiva.',
                    'O músculo tensor do véu palatino atua na elevação do palato mole durante a deglutição para impedir com que o alimento passe para as cavidades nasais.'
                ],
                correctIndex: 4,
                difficulty: 'media', status: 'unanswered',
                rationale: 'A alternativa incorreta é a E, pois quem eleva o palato mole é o músculo *levantador* do véu palatino, não o tensor.'
            },
            {
                id: '1008', cycle: 'basico', discipline: 'Anatomia', subTopic: 'Sistema Muscular',
                text: 'A faringe apresenta uma parede muscular forte capaz de realizar a condução do bolo alimentar e ar, além de projetar a voz para alterá-la. Assinale a alternativa incorreta acerca dessa musculatura.',
                options: [
                    'O músculo estilofaríngeo entra na camada interna na abertura entre os músculos constritores superior e médio.',
                    'O único músculo da faringe que recebe inervação motora pelo n. glossofaríngeo é o músculo estilofaríngeo.',
                    'Os músculos longitudinais da camada interna se unem próximos à sua inserção, inserindo-se em conjunto nas margens posterior e superior da cartilagem tireóidea.',
                    'O músculo salpingofaríngeo é um dos componentes da camada externa da faringe, atuando na elevação da laringe.',
                    'A atuação dos músculos constritores da faringe é na formação de uma crista peristáltica para empurrar o bolo alimentar ao esôfago.'
                ],
                correctIndex: 3,
                difficulty: 'dificil', status: 'unanswered',
                rationale: 'O músculo salpingofaríngeo pertence à camada *interna* (longitudinal) da musculatura da faringe, não à externa.'
            },
            {
                id: '1009', cycle: 'basico', discipline: 'Anatomia', subTopic: 'Neuroanatomia',
                text: 'Qual dos seguintes nervos é o principal responsável pela inervação sensitiva da faringe?',
                options: [
                    'N. glossofaríngeo.',
                    'N. facial.',
                    'N. hipoglosso.',
                    'N. vago.',
                    'N. acessório.'
                ],
                correctIndex: 0,
                difficulty: 'facil', status: 'unanswered',
                rationale: 'O nervo glossofaríngeo (NC IX) fornece a maior parte da inervação sensitiva da mucosa da faringe.'
            },
            {
                id: '1010', cycle: 'basico', discipline: 'Anatomia', subTopic: 'Sistema Digestório',
                text: 'A deglutição é um processo anatomicamente complexo que envolve a coordenação de várias estruturas faríngeas e laríngeas. Assinale a alternativa correta acerca desse processo.',
                options: [
                    'O primeiro passo é a compressão do bolo alimentar contra o palato duro.',
                    'A posição primária do palato antes da deglutição é estar aberto e com bloqueio da nasofaringe.',
                    'Há contração dos músculos faríngeos longitudinais e supra-hioideos para o rebaixamento da laringe.',
                    'Há contração sequencial involuntária dos três músculos constritores que empurra o bolo para o esôfago.',
                    'Os músculos constritores da faringe atuam simultaneamente para a diminuição da luz da faringe.'
                ],
                correctIndex: 3,
                difficulty: 'media', status: 'unanswered',
                rationale: 'Na fase faríngea, ocorre uma onda peristáltica sequencial dos músculos constritores (superior, médio e inferior) para propelir o bolo.'
            },
            {
                id: '1011', cycle: 'basico', discipline: 'Anatomia', subTopic: 'Sistema Digestório',
                text: 'A faringe estende-se desde a sua comunicação com as cavidades nasais até o início do esôfago. Quais são os seus limites superior e inferior?',
                options: [
                    'Base do crânio e margem superior do osso hioide.',
                    'Margem inferior da cartilagem cricoidea e margem inferior da vértebra C VI.',
                    'Margem superior da vértebra C III e margem inferior da vértebra C VII.',
                    'Osso palatino e margem superior do osso hioide.',
                    'Base do crânio e margem inferior da vértebra C VI.'
                ],
                correctIndex: 4,
                difficulty: 'facil', status: 'unanswered',
                rationale: 'A faringe se estende da base do crânio até a margem inferior da cartilagem cricoide, que corresponde ao nível da vértebra C6.'
            }
        ];

        // --- 2. STATE ---
        const state = {
            cycle: 'clinico',
            disciplines: [],
            subTopics: [],
            usePBL: false,
            pblModules: [],
            filters: { unanswered: true, wrong: false },
            limit: 10,
            viewMode: 'list',
            filteredQuestions: [],
            examQuestions: [],
            currentZenIndex: 0,
            eliminatedOptions: {}, 
            userAnswers: {}, 
            db: []
        };

        // --- 3. INICIALIZAÇÃO ---
        function init() {
            generateMockDB();
            renderCycles();
            renderContentArea();
            renderStatusFilters();
            updateCounter();
            lucide.createIcons();
        }

        function generateMockDB() {
            // BASE PREENCHIDA COM QUESTÕES REAIS
            let mocks = [];
            state.db = [...REAL_QUESTIONS, ...mocks];
            document.getElementById('total-db-count').innerText = state.db.length;
        }

        // --- 4. RENDERIZAÇÃO DASHBOARD ---
        function renderCycles() {
            const container = document.getElementById('cycles-container');
            container.innerHTML = CYCLES.map(c => `
                <button onclick="selectCycle('${c.id}')" class="relative p-5 rounded-xl border text-left transition-all duration-300 group ${state.cycle === c.id ? 'active-cycle' : 'bg-slate-800/40 border-slate-700 hover:border-slate-500 hover:bg-slate-800/80'}">
                    <div class="flex items-start justify-between mb-2">
                        <div class="icon-box p-2 rounded-lg transition-colors ${state.cycle === c.id ? '' : 'bg-slate-700 text-slate-400 group-hover:text-slate-200'}">
                            <i data-lucide="${c.icon}" class="w-5 h-5"></i>
                        </div>
                        ${state.cycle === c.id ? '<div class="w-5 h-5 bg-sky-500 rounded-full flex items-center justify-center"><i data-lucide="check" class="w-3 h-3 text-white"></i></div>' : ''}
                    </div>
                    <h3 class="font-semibold mb-1 ${state.cycle === c.id ? 'text-white' : 'text-slate-300 group-hover:text-white'}">${c.label}</h3>
                    <p class="text-xs text-slate-500">${c.description}</p>
                </button>
            `).join('');
            lucide.createIcons();
        }

        function renderContentArea() {
            const container = document.getElementById('content-area');
            if (state.usePBL) {
                container.innerHTML = `
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 fade-in">
                        ${PBL_MODULES.map(mod => `
                            <button onclick="togglePBL('${mod}')" class="p-3 rounded-lg border text-sm text-left transition-all flex items-center gap-3 ${state.pblModules.includes(mod) ? 'bg-purple-600/20 border-purple-500 text-white' : 'bg-slate-900 border-slate-700 text-slate-400 hover:border-slate-600'}">
                                <div class="w-4 h-4 rounded border flex items-center justify-center ${state.pblModules.includes(mod) ? 'bg-purple-500 border-purple-500' : 'border-slate-600'}">
                                    ${state.pblModules.includes(mod) ? '<i data-lucide="check" class="w-3 h-3 text-white"></i>' : ''}
                                </div>
                                ${mod}
                            </button>
                        `).join('')}
                    </div>
                `;
            } else {
                const disciplines = DISCIPLINES[state.cycle];
                const allSelected = state.disciplines.length === disciplines.length;
                let html = `
                    <div class="flex justify-between items-center mb-4 fade-in">
                        <p class="text-sm text-slate-400">Disciplinas: </p>
                        <button onclick="toggleAllDisciplines()" class="text-xs font-medium text-sky-400 hover:underline">
                            ${allSelected ? 'Desmarcar todas' : 'Selecionar todas'}
                        </button>
                    </div>
                    <div class="flex flex-wrap gap-2 mb-6">
                        ${disciplines.map(disc => `
                            <button onclick="toggleDiscipline('${disc}')" class="px-3 py-1.5 rounded-lg text-xs font-medium border transition-all ${state.disciplines.includes(disc) ? 'chip-selected shadow-md' : 'bg-slate-800/50 text-slate-400 border-slate-700 hover:border-slate-600 hover:text-slate-200'}">
                                ${disc}
                            </button>
                        `).join('')}
                    </div>
                `;
                const relevantSubTopics = state.disciplines.filter(d => SUB_TOPICS[d]);
                if (relevantSubTopics.length > 0) {
                    html += `
                        <div class="mt-6 pt-6 border-t border-slate-700/50 slide-up">
                            <h3 class="text-sm font-bold text-slate-400 mb-4 flex items-center gap-2">
                                <i data-lucide="list-filter" class="w-4 h-4 text-sky-500"></i> Filtrar por Temas
                            </h3>
                            <div class="space-y-4">
                                ${relevantSubTopics.map(disc => `
                                    <div class="bg-slate-900/30 rounded-lg p-3 border border-slate-700/30">
                                        <span class="text-xs font-bold text-sky-400 uppercase tracking-wide mb-2 block">${disc}</span>
                                        <div class="flex flex-wrap gap-2">
                                            ${SUB_TOPICS[disc].map(sub => `
                                                <button onclick="toggleSubTopic('${sub}')" class="px-3 py-1.5 rounded-lg text-[10px] font-medium border transition-all ${state.subTopics.includes(sub) ? 'bg-sky-600 text-white border-sky-500' : 'bg-slate-900/80 text-slate-400 border-slate-700 hover:text-slate-200'}">
                                                    ${sub}
                                                </button>
                                            `).join('')}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
                container.innerHTML = html;
            }
            lucide.createIcons();
        }

        function renderStatusFilters() {
            const container = document.getElementById('status-filters');
            container.innerHTML = `
                <div class="flex items-center justify-between py-2">
                    <span class="text-sm text-slate-300 font-medium">Não Respondidas</span>
                    <button onclick="toggleFilter('unanswered')" class="w-11 h-6 rounded-full transition-colors relative ${state.filters.unanswered ? 'bg-sky-500' : 'bg-slate-700'}">
                        <div class="absolute top-1 left-1 bg-white w-4 h-4 rounded-full transition-transform ${state.filters.unanswered ? 'translate-x-5' : 'translate-x-0'}"></div>
                    </button>
                </div>
                <div class="flex items-center justify-between py-2">
                    <span class="text-sm text-slate-300 font-medium">Erros (Revisão)</span>
                    <button onclick="toggleFilter('wrong')" class="w-11 h-6 rounded-full transition-colors relative ${state.filters.wrong ? 'bg-sky-500' : 'bg-slate-700'}">
                        <div class="absolute top-1 left-1 bg-white w-4 h-4 rounded-full transition-transform ${state.filters.wrong ? 'translate-x-5' : 'translate-x-0'}"></div>
                    </button>
                </div>
            `;
        }

        // --- LÓGICA DE INTERAÇÃO ---
        function selectCycle(id) {
            state.cycle = id; state.disciplines = []; state.subTopics = []; state.pblModules = []; state.usePBL = false;
            renderCycles(); renderContentArea(); updateCounter();
        }
        function setMode(mode) {
            state.usePBL = (mode === 'pbl');
            document.getElementById('btn-mode-trad').className = !state.usePBL ? 'px-3 py-1.5 text-xs font-medium rounded-md transition-all bg-slate-700 text-white shadow' : 'px-3 py-1.5 text-xs font-medium rounded-md transition-all text-slate-500 hover:text-slate-300';
            document.getElementById('btn-mode-pbl').className = state.usePBL ? 'px-3 py-1.5 text-xs font-medium rounded-md transition-all bg-purple-600 text-white shadow' : 'px-3 py-1.5 text-xs font-medium rounded-md transition-all text-slate-500 hover:text-slate-300';
            renderContentArea(); updateCounter();
        }
        function toggleDiscipline(disc) {
            if (state.disciplines.includes(disc)) state.disciplines = state.disciplines.filter(d => d !== disc); else state.disciplines.push(disc);
            renderContentArea(); updateCounter();
        }
        function toggleAllDisciplines() {
            const all = DISCIPLINES[state.cycle];
            if (state.disciplines.length === all.length) { state.disciplines = []; state.subTopics = []; } else state.disciplines = [...all];
            renderContentArea(); updateCounter();
        }
        function toggleSubTopic(sub) {
            if (state.subTopics.includes(sub)) state.subTopics = state.subTopics.filter(s => s !== sub); else state.subTopics.push(sub);
            renderContentArea(); updateCounter();
        }
        function togglePBL(mod) {
            if (state.pblModules.includes(mod)) state.pblModules = state.pblModules.filter(m => m !== mod); else state.pblModules.push(mod);
            renderContentArea(); updateCounter();
        }
        function toggleFilter(key) { state.filters[key] = !state.filters[key]; renderStatusFilters(); updateCounter(); }
        function setViewMode(mode) {
            state.viewMode = mode;
            const btnList = document.getElementById('btn-view-list');
            const btnZen = document.getElementById('btn-view-zen');
            if(mode === 'list') {
                btnList.className = "p-3 rounded-lg border bg-sky-500/20 border-sky-500 text-white flex flex-col items-center gap-2 transition-all";
                btnZen.className = "p-3 rounded-lg border bg-slate-800 border-slate-700 text-slate-500 flex flex-col items-center gap-2 transition-all hover:bg-slate-700";
            } else {
                btnZen.className = "p-3 rounded-lg border bg-sky-500/20 border-sky-500 text-white flex flex-col items-center gap-2 transition-all";
                btnList.className = "p-3 rounded-lg border bg-slate-800 border-slate-700 text-slate-500 flex flex-col items-center gap-2 transition-all hover:bg-slate-700";
            }
        }
        function changeLimit(delta) {
            let newVal = state.limit + delta;
            if (newVal < 5) newVal = 5; if (newVal > state.filteredQuestions.length) newVal = state.filteredQuestions.length; if (state.filteredQuestions.length === 0) newVal = 0;
            state.limit = newVal; document.getElementById('q-limit-input').value = newVal;
        }
        function manualLimitChange(val) {
            let num = parseInt(val); if (!num || num < 1) num = 5; state.limit = num; updateCounter();
        }

        // --- FILTRAGEM ---
        function updateCounter() {
            const filtered = state.db.filter(q => {
                if (q.cycle !== state.cycle) return false;
                if (state.usePBL) {
                    if (state.pblModules.length > 0 && !state.pblModules.includes(q.pblModule)) return false;
                    if (!state.pblModules.length && !q.pblModule) return false;
                } else {
                    if (state.disciplines.length > 0) {
                        if (!state.disciplines.includes(q.discipline)) return false;
                        if (state.subTopics.length > 0 && !state.subTopics.includes(q.subTopic)) return false;
                    }
                }
                if (!state.filters.unanswered && q.status === 'unanswered') return false;
                return true;
            });
            state.filteredQuestions = filtered;
            document.getElementById('q-counter').innerText = filtered.length;
            const btn = document.getElementById('btn-generate');
            if (filtered.length > 0) {
                btn.disabled = false;
                btn.className = "w-full py-4 rounded-xl font-bold text-base flex items-center justify-center gap-2 transition-all shadow-lg bg-sky-500 hover:bg-sky-400 text-white hover:shadow-sky-500/25 hover:-translate-y-1 cursor-pointer";
                if (state.limit > filtered.length) state.limit = filtered.length;
                if (state.limit === 0) state.limit = Math.min(10, filtered.length);
                document.getElementById('q-limit-input').value = state.limit;
            } else {
                btn.disabled = true;
                btn.className = "w-full py-4 rounded-xl font-bold text-base flex items-center justify-center gap-2 transition-all shadow-lg bg-slate-800 text-slate-500 cursor-not-allowed";
                state.limit = 0;
                document.getElementById('q-limit-input').value = 0;
            }
        }

        // --- EXAM LOGIC & INTERACTIVITY ---
        function shuffle(array) { return array.sort(() => Math.random() - 0.5); }

        function startExam() {
            let pool = shuffle([...state.filteredQuestions]);
            state.examQuestions = pool.slice(0, state.limit);
            state.currentZenIndex = 0;
            state.eliminatedOptions = {};
            state.userAnswers = {}; 

            document.getElementById('dashboard-view').classList.add('hidden');
            document.getElementById('exam-view').classList.remove('hidden');
            document.getElementById('header-logo-area').onclick = null;
            document.getElementById('nav-dashboard').classList.add('hidden');
            document.getElementById('nav-exam').classList.remove('hidden');
            document.getElementById('nav-exam').classList.add('flex');

            renderQuestions();
            updateZenUI();
        }

        function exitExam() {
            if(confirm('Deseja sair do caderno? O progresso não salvo será perdido.')) resetToDashboard();
        }

        function resetToDashboard() {
            document.getElementById('dashboard-view').classList.remove('hidden');
            document.getElementById('exam-view').classList.add('hidden');
            document.getElementById('nav-dashboard').classList.remove('hidden');
            document.getElementById('nav-exam').classList.add('hidden');
            document.getElementById('nav-exam').classList.remove('flex');
            document.getElementById('header-logo-area').onclick = resetToDashboard;
        }

        function toggleElimination(qId, optIdx) {
            if (!state.eliminatedOptions[qId]) state.eliminatedOptions[qId] = [];
            const list = state.eliminatedOptions[qId];
            if (list.includes(optIdx)) state.eliminatedOptions[qId] = list.filter(i => i !== optIdx); else state.eliminatedOptions[qId].push(optIdx);
            
            const qIndex = state.examQuestions.findIndex(q => q.id === qId);
            refreshQuestionCard(qId, qIndex);
        }

        function selectOption(qId, index) {
            if (state.userAnswers[qId]?.submitted) return;

            if (!state.userAnswers[qId]) state.userAnswers[qId] = { selected: null, submitted: false };
            state.userAnswers[qId].selected = index;

            const qIndex = state.examQuestions.findIndex(q => q.id === qId);
            refreshQuestionCard(qId, qIndex);
        }

        function submitAnswer(qId) {
            if (!state.userAnswers[qId] || state.userAnswers[qId].selected === null) {
                alert("Por favor, selecione uma alternativa antes de responder.");
                return;
            }
            state.userAnswers[qId].submitted = true;
            
            const qIndex = state.examQuestions.findIndex(q => q.id === qId);
            refreshQuestionCard(qId, qIndex);
        }

        function refreshQuestionCard(qId, index) {
            const q = state.examQuestions.find(q => q.id === qId);
            const container = document.getElementById(`q-card-${qId}`);
            if (container) {
                container.outerHTML = renderQuestionHTML(q, index);
                lucide.createIcons();
            }
        }

        function renderQuestionHTML(q, index) {
            const letters = ['A', 'B', 'C', 'D', 'E'];
            const eliminated = state.eliminatedOptions[q.id] || [];
            
            const answerState = state.userAnswers[q.id] || { selected: null, submitted: false };
            const { selected, submitted } = answerState;

            return `
                <div class="bg-slate-800/50 border border-slate-700 rounded-2xl p-6 md:p-8 shadow-2xl relative fade-in" id="q-card-${q.id}">
                    <div class="flex justify-between items-start mb-6 border-b border-slate-700/50 pb-4">
                        <div class="flex flex-col gap-2">
                            <div class="flex items-center gap-2 flex-wrap">
                                <span class="px-2 py-1 rounded bg-slate-700 text-slate-300 text-xs font-bold border border-slate-600">${q.discipline}</span>
                                <span class="px-2 py-1 rounded bg-sky-900/30 text-sky-400 text-xs font-bold border border-sky-500/20">${q.subTopic}</span>
                            </div>
                            <h3 class="text-slate-400 text-sm font-mono mt-1">Questão #${q.id}</h3>
                        </div>
                        <div class="flex items-center gap-2">
                             ${q.difficulty === 'facil' ? '<span class="text-xs font-bold text-green-400 bg-green-400/10 px-2 py-1 rounded">Fácil</span>' : ''}
                             ${q.difficulty === 'media' ? '<span class="text-xs font-bold text-yellow-400 bg-yellow-400/10 px-2 py-1 rounded">Média</span>' : ''}
                             ${q.difficulty === 'dificil' ? '<span class="text-xs font-bold text-red-400 bg-red-400/10 px-2 py-1 rounded">Difícil</span>' : ''}
                        </div>
                    </div>

                    <div class="mb-8">
                        <p class="text-lg text-slate-200 leading-relaxed font-medium">
                            <span class="text-slate-500 font-bold mr-2">${index + 1}.</span> ${q.text}
                        </p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="options-container-${q.id}">
                        ${q.options.map((opt, i) => {
                            const isElim = eliminated.includes(i);
                            const isSelected = selected === i;
                            const isCorrect = i === q.correctIndex;
                            
                            let cardClasses = "relative p-4 rounded-xl border transition-all flex items-start gap-4 group cursor-pointer ";
                            let letterClasses = "w-8 h-8 min-w-[2rem] rounded-full border flex items-center justify-center font-bold transition-colors ";
                            let textClasses = "text-sm md:text-base leading-relaxed flex-1 ";
                            
                            if (!submitted) {
                                if (isElim) {
                                    cardClasses += "bg-slate-900/30 border-slate-800 opacity-60 option-eliminated";
                                    letterClasses += "border-slate-700 text-slate-600";
                                    textClasses += "line-through text-slate-600";
                                } else if (isSelected) {
                                    cardClasses += "bg-sky-500/10 border-sky-500 shadow-sm";
                                    letterClasses += "bg-sky-500 border-sky-500 text-white";
                                    textClasses += "text-white font-medium";
                                } else {
                                    cardClasses += "bg-slate-800/50 border-slate-700 hover:bg-slate-700/50 hover:border-slate-500";
                                    letterClasses += "border-slate-600 text-slate-400 group-hover:border-sky-500 group-hover:text-sky-500";
                                    textClasses += "text-slate-300 group-hover:text-white";
                                }
                            } 
                            else {
                                if (isCorrect) {
                                    cardClasses += "opt-correct";
                                    textClasses += "text-green-100 font-medium";
                                } else if (isSelected && !isCorrect) {
                                    cardClasses += "opt-wrong";
                                    textClasses += "text-red-100";
                                } else {
                                    cardClasses += "bg-slate-900/40 border-slate-800 opacity-50";
                                    letterClasses += "border-slate-700 text-slate-600";
                                    textClasses += "text-slate-500";
                                }
                            }

                            return `
                                <div id="opt-${q.id}-${i}" 
                                     onclick="selectOption('${q.id}', ${i})"
                                     class="${cardClasses}">
                                    
                                    <div class="opt-letter ${letterClasses}">
                                        ${letters[i]}
                                    </div>
                                    
                                    <p class="opt-text ${textClasses}">
                                        ${opt}
                                    </p>

                                    ${!submitted ? `
                                    <button onclick="event.stopPropagation(); toggleElimination('${q.id}', ${i})" 
                                            class="eye-btn absolute top-2 right-2 p-1.5 rounded-full transition-all text-slate-600 hover:text-red-400 hover:bg-slate-700 ${isElim ? 'text-red-500 bg-red-500/10' : ''}">
                                        <i data-lucide="${isElim ? 'eye-off' : 'eye'}" class="eye-icon w-4 h-4"></i>
                                    </button>
                                    ` : ''}
                                </div>
                            `
                        }).join('')}
                    </div>

                    <div class="mt-8 pt-6 border-t border-slate-700/50">
                        ${!submitted ? `
                            <div class="flex justify-end gap-3">
                                <button onclick="submitAnswer('${q.id}')" 
                                        class="bg-sky-600 hover:bg-sky-500 text-white px-8 py-2.5 rounded-lg font-bold shadow-lg shadow-sky-900/20 transition-all">
                                    Responder
                                </button>
                            </div>
                        ` : `
                            <div class="fade-in animate-in slide-in-from-top-2">
                                <div class="bg-slate-900/60 border border-slate-700/50 rounded-xl p-5 relative overflow-hidden">
                                    <div class="absolute left-0 top-0 bottom-0 w-1 ${selected === q.correctIndex ? 'bg-green-500' : 'bg-red-500'}"></div>
                                    <h4 class="text-sm font-bold uppercase tracking-wider mb-2 ${selected === q.correctIndex ? 'text-green-400' : 'text-red-400'}">
                                        ${selected === q.correctIndex ? 'Resposta Correta!' : 'Resposta Incorreta'}
                                    </h4>
                                    <p class="text-slate-300 text-sm leading-relaxed">
                                        ${q.rationale}
                                    </p>
                                </div>
                            </div>
                        `}
                    </div>
                </div>
            `;
        }

        function renderQuestions() {
            const container = document.getElementById('questions-container');
            const label = document.getElementById('exam-mode-label');
            if (state.viewMode === 'list') {
                label.innerText = 'Lista Completa';
                document.getElementById('zen-controls').classList.add('hidden');
                document.getElementById('zen-progress-container').classList.add('hidden');
                container.innerHTML = state.examQuestions.map((q, i) => renderQuestionHTML(q, i)).join('<div class="h-8"></div>');
            } else {
                label.innerText = 'Modo Zen';
                document.getElementById('zen-controls').classList.remove('hidden');
                document.getElementById('zen-progress-container').classList.remove('hidden');
                const q = state.examQuestions[state.currentZenIndex];
                container.innerHTML = renderQuestionHTML(q, state.currentZenIndex);
            }
            lucide.createIcons();
            updateZenUI();
        }

        function updateZenUI() {
            if (state.viewMode !== 'zen') return;
            const percent = ((state.currentZenIndex + 1) / state.examQuestions.length) * 100;
            document.getElementById('zen-progress-bar').style.width = `${percent}%`;
            document.getElementById('zen-current-q').innerText = `Questão ${state.currentZenIndex + 1}`;
            document.getElementById('zen-total-q').innerText = `de ${state.examQuestions.length}`;
            document.getElementById('zen-counter').innerText = `${state.currentZenIndex + 1} / ${state.examQuestions.length}`;
            document.getElementById('btn-zen-prev').disabled = state.currentZenIndex === 0;
            document.getElementById('btn-zen-next').disabled = state.currentZenIndex === state.examQuestions.length - 1;
        }

        function zenNext() { if (state.currentZenIndex < state.examQuestions.length - 1) { state.currentZenIndex++; renderQuestions(); window.scrollTo(0,0); } }
        function zenPrev() { if (state.currentZenIndex > 0) { state.currentZenIndex--; renderQuestions(); window.scrollTo(0,0); } }

        function downloadPDF() {
            if (!window.jspdf) {
                alert("Erro: Biblioteca PDF ainda carregando. Tente novamente em alguns segundos.");
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            const margin = 20;
            let y = 30; // Posição vertical inicial
            const lineHeight = 7;

            // Função para adicionar Marca D'água e Cabeçalho em cada página
            function addPageDecorations() {
                // Marca D'água
                doc.saveGraphicsState();
                doc.setTextColor(230, 230, 230); // Cinza bem claro
                doc.setFontSize(60);
                doc.setFont("helvetica", "bold");
                // Rotaciona e centraliza
                doc.text("MEDNEXUS", pageWidth / 2, pageHeight / 2, { align: "center", angle: 45 });
                doc.restoreGraphicsState();

                // Cabeçalho
                doc.setFontSize(10);
                doc.setTextColor(100);
                doc.setFont("helvetica", "normal");
                doc.text("MEDNEXUS - Banco de Questões Personalizado", margin, 15);
                doc.setDrawColor(200);
                doc.line(margin, 18, pageWidth - margin, 18);
            }

            // Inicia o documento
            addPageDecorations();
            
            // Título
            doc.setFontSize(18);
            doc.setTextColor(0); // Preto
            doc.setFont("helvetica", "bold");
            doc.text("Caderno de Questões", margin, y);
            y += 15;

            state.examQuestions.forEach((q, i) => {
                // Verifica se cabe na página (estimativa), senão cria nova
                if (y > pageHeight - 50) {
                    doc.addPage();
                    addPageDecorations();
                    y = 30;
                }

                // Número e Disciplina da Questão
                doc.setFontSize(12);
                doc.setFont("helvetica", "bold");
                doc.setTextColor(0, 102, 204); // Azul MedNexus
                doc.text(`Questão ${i + 1} - ${q.discipline} (${q.subTopic})`, margin, y);
                y += 8;

                // Enunciado
                doc.setFontSize(11);
                doc.setFont("helvetica", "normal");
                doc.setTextColor(0);
                const splitText = doc.splitTextToSize(q.text, pageWidth - (margin * 2));
                doc.text(splitText, margin, y);
                y += (splitText.length * 6) + 5;

                // Alternativas
                q.options.forEach((opt, idx) => {
                    // Verifica quebra de página dentro das alternativas
                    if (y > pageHeight - 20) {
                        doc.addPage();
                        addPageDecorations();
                        y = 30;
                    }

                    const letter = String.fromCharCode(65 + idx);
                    const optText = `(   )  ${letter}) ${opt}`;
                    const splitOpt = doc.splitTextToSize(optText, pageWidth - (margin * 2) - 5);
                    
                    doc.text(splitOpt, margin + 5, y);
                    y += (splitOpt.length * 6) + 2;
                });

                y += 10; // Espaço entre questões
                
                // Linha separadora suave
                doc.setDrawColor(240);
                doc.line(margin, y - 5, pageWidth - margin, y - 5);
            });

            // Rodapé com data
            const date = new Date().toLocaleDateString('pt-BR');
            doc.setFontSize(8);
            doc.setTextColor(150);
            doc.text(`Gerado em ${date}`, margin, pageHeight - 10);

            doc.save("caderno_mednexus.pdf");
        }

        window.onload = init;
    </script>
</body>
</html>